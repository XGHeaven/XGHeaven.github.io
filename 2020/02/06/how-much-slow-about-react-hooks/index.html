
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="XGHeaven&#39;s Blog">
    <title>React Hooks 究竟有多慢？ - XGHeaven&#39;s Blog</title>
    <meta name="author" content="XGHeaven">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="自从 Hooks 诞生以来，官方就有考虑到了性能的问题。添加了各种方法优化性能，比如 memo、hooks deps、lazy initilize 等。而且在官方 FAQ 中也有讲到，Function 组件每次创建闭包函数的速度是非常快的，而且随着未来引擎的优化，这个时间进一步缩短，所以我们这里根本不需要担心函数闭包的问题。 当然这一点也通过我的实验证实了，确实不慢，不仅仅是函数闭包不慢，就算是大">
<meta property="og:type" content="blog">
<meta property="og:title" content="React Hooks 究竟有多慢？">
<meta property="og:url" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/index.html">
<meta property="og:site_name" content="XGHeaven&#39;s Blog">
<meta property="og:description" content="自从 Hooks 诞生以来，官方就有考虑到了性能的问题。添加了各种方法优化性能，比如 memo、hooks deps、lazy initilize 等。而且在官方 FAQ 中也有讲到，Function 组件每次创建闭包函数的速度是非常快的，而且随着未来引擎的优化，这个时间进一步缩短，所以我们这里根本不需要担心函数闭包的问题。 当然这一点也通过我的实验证实了，确实不慢，不仅仅是函数闭包不慢，就算是大">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/d2226e34-5a04-4bef-a525-129141b5dc8b.jpg">
<meta property="og:image" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/3936f68c-543c-42b6-854e-3bf13a868c66.png">
<meta property="og:image" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/c9566ca6-24bf-4afa-a39a-3af55953b1d9.png">
<meta property="og:image" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/94335857-9c76-43a7-8067-503032ae5511.png">
<meta property="article:published_time" content="2020-02-05T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-16T15:51:09.755Z">
<meta property="article:author" content="XGHeaven">
<meta property="article:tag" content="React">
<meta property="article:tag" content="React Hooks">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/d2226e34-5a04-4bef-a525-129141b5dc8b.jpg">
<meta name="twitter:creator" content="@XGHeaven">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=640"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-mhhgzztqkaub4zd4cl8bd83f7mgh9j6njnhilft4hamhrjsliqyzwo2cfzdk.min.css">

    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-71388235-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?9894361f828b64144ac1f2ac0c58c300";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/%20">XGHeaven&#39;s Blog</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=90"/>
        
        </a>
    
</header>
            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=110"/>
            </a>
            <span class="sidebar-profile-name">XGHeaven</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/%20"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/friend-link"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-link"></i>
                    <span class="sidebar-button-desc">友情链接</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/XGHeaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/xgheaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://facebook.com/xgheaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/xgheaven/" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xgheaven@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">邮箱</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/changelog"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-line-chart"></i>
                    <span class="sidebar-button-desc">Changelog</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            React Hooks 究竟有多慢？
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Thu Feb 06 2020 00:00:00 GMT+0800">
	
		    2月 06, 2020
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Frontend/">Frontend</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>自从 Hooks 诞生以来，官方就有考虑到了性能的问题。添加了各种方法优化性能，比如 memo、hooks deps、lazy initilize 等。而且在官方 FAQ 中也有讲到，Function 组件每次创建闭包函数的速度是非常快的，而且随着未来引擎的优化，这个时间进一步缩短，所以我们这里根本不需要担心函数闭包的问题。</p>
<p>当然这一点也通过我的实验证实了，确实不慢，不仅仅是函数闭包不慢，就算是大量的 Hooks 调用，也是非常快的。简单来说，1 毫秒内大约可以运行上千次的 hooks，也就是 <code>useState</code> <code>useEffect</code> 的调用。而函数的创建，就更多了，快的话十万次。</p>
<p>很多人都觉得既然官方都这么说了，那我们这么用也就好了，不需要过分担心性能的问题。我一开始也是这样想的。但是直到最近有一次我尝试对公司项目里面一个比较复杂的组件用 Hooks 重写，我惊奇的发现重渲染时间竟然从 2ms 增长到了 4ms。业务逻辑没有任何变化，唯一的变的是从 Class 变成了 Hooks。这让我有点难以相信，我一直觉得就算是慢也不至于慢了一倍多吧，怎么着两者差不多吧。于是我开始无差别对比两个写法的性能区别。</p>
<h2 id="懒人阅读指南"><a href="#懒人阅读指南" class="headerlink" title="懒人阅读指南"></a>懒人阅读指南</h2><p>我相信肯定很多懒人不想看下面的分析，想直接看结果。没问题，满足你们，直接通过目录找到最后看「总结」就好了，如果你觉得有问题或者觉得我说的不对，可以重新仔细阅读一下文章，帮我指出哪里有问题。</p>
<h2 id="为什么有这篇文章"><a href="#为什么有这篇文章" class="headerlink" title="为什么有这篇文章"></a>为什么有这篇文章</h2><p>其实我原本不是很想写一篇文章的，因为我觉得这个只是很简单的一个对比。于是我只是在掘金的沸点上随口吐槽了两句，结果……我决定写一篇文章。主要是觉得这群人好 two，就算是质疑也应该先质疑我的测量方式，而不是说我的使用方式。都用了这么多年了，还能用错）滑稽脸</p>
<img src="/2020/02/06/how-much-slow-about-react-hooks/d2226e34-5a04-4bef-a525-129141b5dc8b.jpg">
<p>不过既然要写，就写的完备一些，尽量把一些可能的情况都覆盖了，顺便问问大家是否有问题。如果大家对下面的测试方法或者内容有任何问题的话，请大家正常交流哦，千万不要有一些过激或者偏激的言论。因为性能测试这东西，一人一个方法，一人一个想法。</p>
<p>既然说道这里，其实有一点我要说，沸点里面说到的 50% 这个测量数据确实有些问题。主要有这么几个原因，第一，我当初只是想抱着试试的心态，于是就直接在开发模式下运行的。第二，平时写代码写习惯了，就直接用了 <code>Date.now()</code> 而没有使用精度更高 <code>performance.now()</code> 从而导致了误差略微有点大。虽然误差略大，但是大方向还是没错的</p>
<p>后文的测试中，我也将这些问题修复了，尽量给大家一个正确的数据。</p>
<h2 id="开始之前，我们要知道……"><a href="#开始之前，我们要知道……" class="headerlink" title="开始之前，我们要知道……"></a>开始之前，我们要知道……</h2><p>假设现在有 <code>HookComp</code> 和 <code>ClassComp</code> 两个组件分别表示函数式组件和类组件，后文用 Hook(HC) 和 Class(CC) 代替。</p>
<h3 id="功能定义"><a href="#功能定义" class="headerlink" title="功能定义"></a>功能定义</h3><p>为了更加贴近实际，这里假设两个组件都要完成相同的一个功能。那就是<strong>用户登录</strong>这个流程：</p>
<ul>
<li><p>有用户名输入框和密码输入框</p>
</li>
<li><p>有一个登录按钮，点击之后校验用户名是否为 <code>admin</code> 且密码为 <code>admin</code></p>
</li>
<li><p>如果校验成功，下方提示登录成功，否则提示用户名或者密码错误</p>
</li>
<li><p>每次输入内容，都将清空内容</p>
</li>
<li><p>另外为了消除误差，额外添加一个按钮，用于触发 100 次的 render，并 log 出平均的渲染时间。</p>
</li>
</ul>
<img src="/2020/02/06/how-much-slow-about-react-hooks/3936f68c-543c-42b6-854e-3bf13a868c66.png" title="DEMO">
<p>具体的业务逻辑的实现，请看后面的 DEMO 地址。</p>
<p>另外因为 Class 组件有 setState 可以自动实现 batch 更新，但是 Hook 不行，所以这里实现的时候把所有的更新操作都放在 React 事件中同步更新，众所周知，React 的事件是自带 batch 更新的，从而保证只有一次渲染。保证两者功能效果一致。</p>
<h3 id="对比常量"><a href="#对比常量" class="headerlink" title="对比常量"></a>对比常量</h3><ul>
<li><p>2018 款 15 寸 MacBook Pro 入门款，i7-8750H 6 核 12 线程 + 16g + 256g</p>
</li>
<li><p>Chrome Stable 79.0.3945.117</p>
</li>
<li><p>react <code>16.12.0</code> PS: 其实我从 <code>16.8.0</code> 就开始测试了，懒癌发作一直没有继续搞</p>
</li>
<li><p>react-dom <code>16.12.0</code></p>
<p>React 全家桶版本全部使用<strong>生产模式</strong>，降低开发模式的影响。</p>
</li>
</ul>
<h3 id="衡量标准：从函数调用到渲染到-DOM-上的时间"><a href="#衡量标准：从函数调用到渲染到-DOM-上的时间" class="headerlink" title="衡量标准：从函数调用到渲染到 DOM 上的时间"></a>衡量标准：从函数调用到渲染到 DOM 上的时间</h3><p>这个时间其实当组件量非常大的时候其实是不准的，因为大家调用的时间是不同的，但是渲染到 DOM 上的时间基本是一致的，就会导致在组件树越浅越前的组件测量出来的时间就会越长。但是这里的情况是页面只有一个对比组件，所以可以暂时用这个作为衡量标准。</p>
<p>针对 HC 来说</p>
<ul>
<li><p>在组件运行的一开始就记录为开始时间</p>
</li>
<li><p>使用 <code>useLayoutEffect</code> 的回调作为结束时间。该 Hook 会在组件挂载或者更新 DOM 之后同步调用。而 <code>useEffect</code> 会在下一个 tick 调用，如果使用该 hook 就会导致最终测量出来的结果普遍慢一些。</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hooks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> now = performance.now()</span><br><span class="line">	useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(performance.now() - now))</span><br><span class="line">	<span class="keyword">return</span> (<span class="comment">/* ui */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>针对 CC 来说</p>
<ul>
<li><p>当运行 render 方法的时候，记录时间</p>
</li>
<li><p>当运行 <code>componentDidUpdate</code> 或者 <code>componentDidMount</code> 的时候，打印耗时。这两个钩子都是在组件挂载或者更新 DOM 之后同步调用，与 <code>useLayoutEffect</code> 调用时机一致。</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Class <span class="keyword">extends</span> Component &#123;</span><br><span class="line">	componentDidMount = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.log()</span><br><span class="line">	componentDidUpdate = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.log()</span><br><span class="line">	log = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(performance.now() - <span class="keyword">this</span>.now)</span><br><span class="line">	render() &#123;</span><br><span class="line">		<span class="keyword">this</span>.now = performance.now()</span><br><span class="line">		<span class="keyword">return</span> (<span class="comment">/* ui */</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试流程和结果计算"><a href="#测试流程和结果计算" class="headerlink" title="测试流程和结果计算"></a>测试流程和结果计算</h3><ul>
<li><p>页面刷新，此时要针对测试内容先进行 5 轮预热测试。目的是为了让 Chrome 对热区代码进行优化，达到最高的性能。</p>
</li>
<li><p>每一轮包含若干次的渲染，比如 100 次或者 50 次，对于每一轮测试，都会抛弃 5% 最高和最低一共 10% 的数据，只保留中间的值，并对这些值计算平均值得到该轮测试结果</p>
</li>
<li><p>然后进行 5 轮正常测试，记录每次的结果，统计平均值。</p>
</li>
<li><p>将此时的值计算作为最终的数据值</p>
</li>
</ul>
<h3 id="DEMO-地址"><a href="#DEMO-地址" class="headerlink" title="DEMO 地址"></a>DEMO 地址</h3><ul>
<li><p>代码：<a href="https://codesandbox.io/s/how-much-hooks-slow-hso28" target="_blank" rel="noopener">CodeSandBox</a> </p>
</li>
<li><p>展示地址：<a href="https://csb-hso28.netlify.com/" target="_blank" rel="noopener">https://csb-hso28.netlify.com/</a></p>
</li>
</ul>
<p>PS: CodeSandBox 似乎不能以生产模式运行，不过你可以将它一键部署到 ZEIT 或者 netlify 上面，查看生产环境的效果。</p>
<h2 id="开胃菜-重渲染测试结果"><a href="#开胃菜-重渲染测试结果" class="headerlink" title="开胃菜-重渲染测试结果"></a>开胃菜-重渲染测试结果</h2><p>最为开胃菜，用一个最常见的场景来测试实在是最合适不过了，那就是组件的重渲染。话说不多，直接上测试结果</p>
<table>
<thead>
<tr>
<th>Avg. Time(ms)</th>
<th>Hook Slow</th>
<th>Hook(Self)</th>
<th>Class</th>
<th>Class(Self)</th>
<th>Hook</th>
<th>Self</th>
</tr>
</thead>
<tbody>
<tr>
<td>第五次平均时间</td>
<td>0.171808623414</td>
<td>0.04126375367107627</td>
<td>0.1941208809532307</td>
<td>0.024725271102327567</td>
<td>0.22747252228577713</td>
<td>0.6688898374583169</td>
</tr>
<tr>
<td>第四次平均时间</td>
<td>0.1696739222</td>
<td>0.04082417709159327</td>
<td>0.18879122377096952</td>
<td>0.02120880942259516</td>
<td>0.22082417118516598</td>
<td>0.9248688730306829</td>
</tr>
<tr>
<td>第三次平均时间</td>
<td>0.160409555184</td>
<td>0.04109888910674132</td>
<td>0.1931868181410399</td>
<td>0.022967028748858104</td>
<td>0.22417582970644748</td>
<td>0.7894734907224213</td>
</tr>
<tr>
<td>第二次平均时间</td>
<td>0.130965058748</td>
<td>0.045824176785382593</td>
<td>0.2072527365001676</td>
<td>0.02346153545019391</td>
<td>0.23439560331158585</td>
<td>0.953161884168321</td>
</tr>
<tr>
<td>第一次平均时间</td>
<td>0.216216175927</td>
<td>0.04549450906259673</td>
<td>0.20939560484263922</td>
<td>0.02357143663115554</td>
<td>0.2546703217776267</td>
<td>0.9300694214990858</td>
</tr>
</tbody>
</table>
<p>简单解释下数据，Hook 和 Class 是通过上面规定的方式统计出来的数据，而 Hook(Self) Class(Self) 是计算了 HC 和 CC 函数调用的时间，最后的 Self 和 Hook Slow 则是 Hook 相比 Class 慢的百分比。这里只需要关注不带 Self 的数据即可。</p>
<p>让我们来细细「品味」一下，Hook 比 Class 慢了 16%。</p>
<p>等等？？？ 16%，emmm……乍一听这是一个多么惊人的数字，5 % 的性能降低都很难接受了，何况是 16%。如果你的页面中有上百个这样组件，想想都知道……咦~~~那酸爽</p>
<p>Wait!!! 或许有人会说了，抛开数值大小谈相对值，这根本就是耍流氓么。每个组件组件都是毫秒级别的渲染，这么小的级别作比较误差也会很大。而且你的测试的测量方式真的很对么？为啥看到很多文章说 Hooks 性能甚至比 Class 组件还高啊。而且你这个测量真的准确么？</p>
<p>这里先回答一下测量的问题，上面也说了，useLayoutEffect 和 CDU/CDM 基本是一致的，而且为了佐证，这里直接上 Performance 面板的数据，虽然只能在开发模式下才能看到这部分数据，但依旧具有参考意义</p>
<img src="/2020/02/06/how-much-slow-about-react-hooks/c9566ca6-24bf-4afa-a39a-3af55953b1d9.png" title="Hooks">
<img src="/2020/02/06/how-much-slow-about-react-hooks/94335857-9c76-43a7-8067-503032ae5511.png" title="Class">
<p>当然因为我这里只是截取了一个样例，没法给大家一个平均的值，但是如果大家多次尝试可以发现就算是 React 自己打的标记点，Class 也会比 Hook 快那么一点点。</p>
<p>而针对更多的疑问，这里我们就基于这个比较结果，引申出更多的比较内容，来逐步完善：</p>
<ul>
<li><p>挂载性能如何？也就是第一次渲染组件</p>
</li>
<li><p>大量列表渲染性能如何？没准渲染的组件多了，性能就不会呈现线性叠加呢？</p>
</li>
<li><p>当 Class 被很多 HOC 包裹的时候呢？</p>
</li>
</ul>
<h2 id="其他对比"><a href="#其他对比" class="headerlink" title="其他对比"></a>其他对比</h2><h3 id="挂载性能"><a href="#挂载性能" class="headerlink" title="挂载性能"></a>挂载性能</h3><p>通过快速卸载挂载 40 次计算出平均时间，另外将两者横向布局，降低每次挂载卸载的时候 Chrome Layout&amp;Paint 上的差异。话不多说，直接上结果</p>
<table>
<thead>
<tr>
<th>Avg. Time(ms)</th>
<th>Hook Slow(%)</th>
<th>Hook(Self)</th>
<th>Class(Self)</th>
<th>Hook</th>
<th>Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>第三次平均时间</td>
<td>0.100681682204</td>
<td>0.04797298587053209</td>
<td>0.024729729252489837</td>
<td>0.5672973001728187</td>
<td>0.5154054158845464</td>
</tr>
<tr>
<td>第二次平均时间</td>
<td>0.137816482105</td>
<td>0.041216209128096294</td>
<td>0.02486483395301007</td>
<td>0.6013513618224376</td>
<td>0.5285134916571347</td>
</tr>
<tr>
<td>第四次平均时间</td>
<td>0.009446076914</td>
<td>0.04378377736822979</td>
<td>0.025405410073093465</td>
<td>0.5343243404216057</td>
<td>0.5293243023491389</td>
</tr>
<tr>
<td>第五次平均时间</td>
<td>0.05774346214</td>
<td>0.041081066671255474</td>
<td>0.025540552529934292</td>
<td>0.5371621495263802</td>
<td>0.5078378347428264</td>
</tr>
<tr>
<td>第一次平均时间</td>
<td>0.036722530281</td>
<td>0.04027024968653112</td>
<td>0.025810805980015446</td>
<td>0.5608108209295047</td>
<td>0.5409459180727199</td>
</tr>
</tbody>
</table>
<p>通过交替运行连续跑 5 轮 40 次测试，可以得到上面这个表格。可以发现，不管那一次运行，都是 Class 时间会少于 Hook 的时间。通过计算可得知，Hook 平均比 Class 慢了 (0.53346 - 0.49811) / 0.49811 = 7%，绝对差值为 0.03535ms。</p>
<p>这个的性能差距可以说是很少了，如果挂载上百个组件的时候，两者差距基本是毫秒内的差距。而且可以看出来，绝对值的差距可以说是依旧没有太多的变化，甚至略微微微微减少，可以简单的认为其实大部分的时间依旧都花费在一些常数时间上，比如 DOM。</p>
<h3 id="大列表性能"><a href="#大列表性能" class="headerlink" title="大列表性能"></a>大列表性能</h3><p>通过渲染 100 个列表的数据计算出平均时间。</p>
<table>
<thead>
<tr>
<th>Avg. Time(ms)</th>
<th>Hook(500)</th>
<th>Hook</th>
<th>Hook Slow(%,500)</th>
<th>Hook Slow(%)</th>
<th>Class(500)</th>
<th>Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>第二次平均时间</td>
<td>9.59723405143682</td>
<td>2.6090425597701934</td>
<td>0.10286063613</td>
<td>0.104480973312</td>
<td>8.702127664211266</td>
<td>2.3622340473168073</td>
</tr>
<tr>
<td>第三次平均时间</td>
<td>9.64329787530005</td>
<td>2.5888297637488615</td>
<td>0.10438723417</td>
<td>0.104028668798</td>
<td>8.731808533218313</td>
<td>2.344893603684737</td>
</tr>
<tr>
<td>第一次平均时间</td>
<td>9.55063829376818</td>
<td>2.5251063647026077</td>
<td>0.085798601307</td>
<td>0.081415992606</td>
<td>8.795957447604296</td>
<td>2.335000020313136</td>
</tr>
<tr>
<td>第五次平均时间</td>
<td>9.597553207756992</td>
<td>2.571702087694343</td>
<td>0.10075770158</td>
<td>0.15273472846</td>
<td>8.719042523149797</td>
<td>2.230957413012994</td>
</tr>
<tr>
<td>第四次平均时间</td>
<td>9.604468084673615</td>
<td>2.567340426662184</td>
<td>0.095974553092</td>
<td>0.0995534837</td>
<td>8.76340427574642</td>
<td>2.334893631570517</td>
</tr>
</tbody>
</table>
<p>我们先不计算下慢了多少，先看看这个数值，100 次渲染一共 2ms 多，平均来说一次 0.02ms，而而我们上面测试的时候发现，单独渲染一个组件，平均需要 0.2ms，这中间的差距是有点巨大的。</p>
<p>而如何合理解释这个问题呢？只能说明在组件数小的时候，React 本身所用的时间与组件的时间相比来说比例就会比较大，而当组件多了起来之后，这部分就变少了。</p>
<p>换句话说，React Core 在这中间占用了多少时间，我们不得而知，但是我们知道肯定是不少的。</p>
<h3 id="HOC"><a href="#HOC" class="headerlink" title="HOC"></a>HOC</h3><p>Hook 的诞生其实就是为了降低逻辑的复用，简单来讲就是简化 HOC 这种方式，所以和 Hook 对线的其实是 HOC。最简单的例子，Mobx 的注入，就需要 inject 高阶组件包裹才可以，但是对于 Hook 来讲，这一点完全不需要。</p>
<p>这里测试一下 Class 组件被包裹了 10 层高阶组件的情况下的性能，每一层包裹的组件做的事情非常简单，那就是透传 props。</p>
<p>啥？你说根本不可能套 10 层？其实也是很容易的，你要注意这里我们所说的 10 层其实是指有 10 层组件包裹了最终使用的组件。比如说大家都知道 mobx inject 方法或者 redux 的 connect 方法，看似只被包裹了一层，其实是两层，因为还有一层 <code>Context.Consumer</code>。同理你再算上 History 的 HOC，也是一样要来两层的。再加上一些其他的东西，再加一点夸张不就够了，手动滑稽）</p>
<table>
<thead>
<tr>
<th>Avg. Time(ms)</th>
<th>Class With 10 HOC</th>
</tr>
</thead>
<tbody>
<tr>
<td>第五轮</td>
<td>0.25384614182697546</td>
</tr>
<tr>
<td>第四轮</td>
<td>0.27269232207602195</td>
</tr>
<tr>
<td>第二轮</td>
<td>0.2821977993289193</td>
</tr>
<tr>
<td>第三轮</td>
<td>0.278846147951189</td>
</tr>
<tr>
<td>第一轮</td>
<td>0.2710439444898249</td>
</tr>
</tbody>
</table>
<p>这结果也就是很清楚了吧，在嵌套较多 HOC 的时候，Class 的性能其实并不好，从 0.19855ms 增加到 0.27173ms，时间接近有 26% 的增加。而这个性能不好并不是因为 Class，而是因为渲染的组件过多导致的。从另一个角度，hook 就没有这种烦恼，即使是大量 Hook 调用性能依旧在可接受范围内。</p>
<h2 id="量化娱乐一下？"><a href="#量化娱乐一下？" class="headerlink" title="量化娱乐一下？"></a>量化娱乐一下？</h2><p>有了上面的数据，来做一个有意思的事情，将数据进行量化。</p>
<p>假设有如下常数，<code>r</code> 表示 React 内核以及其他和组件数无关的常数，<code>h</code> 表示 hook 组件的常数，而 <code>c</code> 表示 Class 组件的常数，<code>T</code> 表示最终所消耗的时间。可以得知这四个参数肯定不为负数。</p>
<p>通过简单的假设，可以得到如下等式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">T(n,m) = hn + cm + r</span><br><span class="line">// n 表示 hook 组件的数量</span><br><span class="line">// m 表示 class 组件的数量</span><br></pre></td></tr></table></figure>
<p>想要计算得到 <code>r</code> <code>h</code> <code>c</code>  参数也很–简单–，简单个鬼，因为数据不是准确的，不能直接通过求解三元一次方程组的方式，而是要通过多元一次拟合的方式求得，而我又不想装 matlab，于是千辛万苦找到一个支持在线计算多元一次方程的网站算了下，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">h = 0.0184907294</span><br><span class="line">c = 0.01674766395</span><br><span class="line">r = 0.4146159332</span><br><span class="line">RSS = 0.249625719</span><br><span class="line">R^2 = 0.9971412136</span><br></pre></td></tr></table></figure>
<p>这个拟合的结果有那么一点点差强人意，因为如果你把单个 Class 或者 Hook 的结果代入的话，会发现偏差了有一倍多。所以我上面也说道只是娱乐娱乐，时间不够也没法细究原因了。不过从拟合的结果上来看，也能发现一个现象，那就是 h 比 c 要大。</p>
<p>另外观察最后的拟合度，看起来 0.99 很大了，但实际上并没有什么意义。而且这里数据选取的也不是很好，做拟合最好还是等距取样，这样做出来的数据会更加准确。这里只是突然奇想想要玩玩看，所以就随便做了下。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不管你是空降过来的还是一点点阅读到这里的，我这边先直接说基于上面的结论：</p>
<ul>
<li><p>当使用 Hook 的时候，整体性能相比 Class 组件会有 10 - 20% 的性能降低。</p>
</li>
<li><p>当仅仅使用函数式组件，而不使用 Hook 的时候，性能不会有降低。也就是说可以放心使用纯函数式组件</p>
</li>
<li><p>Hook 的性能降低不仅仅体现在渲染过程，就算是在第一次挂载过程中，也相比 Class 有一定程度的降低</p>
</li>
<li><p>Hook 的性能降低有三部分</p>
<ul>
<li><p>第一部分是 Hook 的调用，比如说 <code>useState</code> 这些。但是这里有一点需要注意的是，这里的调用指的是有无，而不是数量。简单来说就是从 0 到 1，性能降低的程度远远高于 从 1 到 n。</p>
</li>
<li><p>第二部分是因为引入 Hook 而不得不在每次渲染的时候创建大量的函数闭包，临时对象等等</p>
</li>
<li><p>第三部分是 React 对 Hook 处理所带来的额外消耗，比如对 Hook 链表的管理、对依赖的处理等等。随着 Hook 的增加，这些边际内容所占用的时间也会变得越来越大。</p>
</li>
</ul>
</li>
<li><p>但 Hook 有一点很强，在逻辑的复用上，是远高于 HOC 方式，算是扳回一局。</p>
</li>
</ul>
<p>所以 Hook 确实慢，慢的有理有据。但究竟用不用 Hooks 就全看，我不做定夺。凡事都有两面，Hooks 解决了 Class 一些短板，但是也引入了一些不足。如果一定要我推荐的话，我推荐 Hooks+Mobx。</p>
<h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><ul>
<li><a href="http://www.xuru.org/rt/MLR.asp" target="_blank" rel="noopener">多元一次方程在线拟合</a></li>
</ul>
<h2 id="One-More"><a href="#One-More" class="headerlink" title="One More"></a>One More</h2><p>以上内容是我花了快一个月一点点整理出来的，甚至还跨了个与众不同的「年」。性能测试本身就是一个很有争议的东西，不同的写法不同的测试方式都会带来不同的结果。我也是在这期间一点点修改我的测试内容，从最开始只有单组件测试，到后来添加了组件列表的测试，以及挂载的测试。另外对数据收集也修改了很多，比如多次取平均值，代码预热等等。每一次修改都意味着所有测试数据要重新测试，但我只是想做到一个公平的对比。</p>
<p>就在现在，我依旧会觉得测试里面有很多内容依旧值得去改进，但是我觉得拖的时间太长了，而且我认为把时间花在从源码角度分析为什么 Hook 比 Class 慢上远比用数据证明要有意义的多。</p>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/React/" rel="tag">React</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/React-Hooks/" rel="tag">React Hooks</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/07/hooks-mobx-is-a-very-good/"  data-tooltip="Hooks &amp; Mobx 只需额外知道两个 Hook，便能体验到如此简单的开发方式">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/10/13/use-self-signed-ca-to-protect-your-self-content/" data-tooltip="如何使用自签名 CA 和证书来保护个人在公网上的内容">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2023 XGHeaven. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/07/hooks-mobx-is-a-very-good/"  data-tooltip="Hooks &amp; Mobx 只需额外知道两个 Hook，便能体验到如此简单的开发方式">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/10/13/use-self-signed-ca-to-protect-your-self-content/" data-tooltip="如何使用自签名 CA 和证书来保护个人在公网上的内容">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-google-plus"></i><span class="">分享到 Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/">
                <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=110"/>
        
            <h4 id="about-card-name">XGHeaven</h4>
        
            <h5 id="about-card-bio"><p>一个弱弱的码农</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>杭州电子科技大学学生一枚</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Weifang Shandong, China
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/static/images/20170217-TombRaider.jpg');"></div>
    </body>
    <!--SCRIPTS-->

<script src="/assets/js/scrip-z6xcdnzggiy56kzp83ux5nnbwra1acrauxruz3kdi3u5xladb6jh4n3ylebm.min.js"></script>

<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'https://blog.xgheaven.com/2020/02/06/how-much-slow-about-react-hooks/';
                 
                    this.page.identifier = '2020/02/06/how-much-slow-about-react-hooks/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'xgheaven-blog';
                s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



</html>
