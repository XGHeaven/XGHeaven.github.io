
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="XGHeaven&#39;s Blog">
    <title>归档 - XGHeaven&#39;s Blog</title>
    <meta name="author" content="XGHeaven">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta property="og:type" content="blog">
<meta property="og:title" content="XGHeaven&#39;s Blog">
<meta property="og:url" content="https://blog.xgheaven.com/archives/page/2/index.html">
<meta property="og:site_name" content="XGHeaven&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="XGHeaven">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@XGHeaven">
    
    
        
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=640"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-mhhgzztqkaub4zd4cl8bd83f7mgh9j6njnhilft4hamhrjsliqyzwo2cfzdk.min.css">

    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-71388235-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?9894361f828b64144ac1f2ac0c58c300";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/%20">XGHeaven&#39;s Blog</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=90"/>
        
        </a>
    
</header>
            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=110"/>
            </a>
            <span class="sidebar-profile-name">XGHeaven</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/%20"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/friend-link"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-link"></i>
                    <span class="sidebar-button-desc">友情链接</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/XGHeaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://twitter.com/xgheaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                    <span class="sidebar-button-desc">Twitter</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://facebook.com/xgheaven" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://www.linkedin.com/xgheaven/" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                    <span class="sidebar-button-desc">LinkedIn</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xgheaven@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">邮箱</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/changelog"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-line-chart"></i>
                    <span class="sidebar-button-desc">Changelog</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    

<section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2019/03/12/257-days-in-netease/">
                            一个 18 届前端校招生在网易的 257 天
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Tue Mar 12 2019 00:00:00 GMT+0800">
	
		    3月 12, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E7%BB%8F%E5%8E%86/">工作经历</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B"><span class="toc-text">心路历程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%8F%E5%A4%96-%E2%80%94%E2%80%94-%E6%A0%A1%E6%8B%9B%E5%AD%A3%E6%8B%BF%E5%88%B0%E4%BA%86%E7%BD%91%E6%98%93-Offer"><span class="toc-text">意外 —— 校招季拿到了网易 Offer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%9F%E5%BE%85-%E2%80%94%E2%80%94-%E5%97%A8%EF%BC%8C%E7%8C%AA%E8%A1%8C%E5%8A%A8"><span class="toc-text">期待 —— 嗨，猪行动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%A1%E8%B6%B3-%E2%80%94%E2%80%94-Mini-%E9%A1%B9%E7%9B%AE-%E3%80%8E%E6%9D%A5%E4%BA%BA%E5%90%96%E3%80%8F"><span class="toc-text">满足 —— Mini 项目 『来人吖』</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E5%BE%80-%E2%80%94%E2%80%94-%E5%B0%B1%E8%A6%81%E6%AD%A5%E5%85%A5%E7%9C%9F%E6%AD%A3%E7%9A%84%E4%B8%9A%E5%8A%A1%E7%BA%BF%E5%8E%BB%E4%BA%86"><span class="toc-text">向往 —— 就要步入真正的业务线去了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%81-%E2%80%94%E2%80%94-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%92%8C%E6%88%91%E6%83%B3%E8%B1%A1%E7%9A%84%E4%B8%8D%E4%B8%80%E6%A0%B7%EF%BC%8C%E7%94%9A%E8%87%B3%E8%AF%B4%E6%98%AF%E9%9D%9E%E5%B8%B8%E9%9D%9E%E5%B8%B8%E9%9D%9E%E5%B8%B8%E4%B8%8D%E4%B8%80%E6%A0%B7"><span class="toc-text">愁 —— 为什么和我想象的不一样，甚至说是非常非常非常不一样</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%B7%E8%8C%AB-%E2%80%94%E2%80%94-%E5%AE%8C%E5%85%A8%E7%9C%8B%E4%B8%8D%E5%88%B0%E6%96%B9%E5%90%91"><span class="toc-text">迷茫 —— 完全看不到方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%BB%E5%BC%80-%E2%80%94%E2%80%94-%E5%8D%B4%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E7%95%99%E5%BF%B5"><span class="toc-text">离开 —— 却没有任何留念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%9F%E8%B0%A2"><span class="toc-text">感谢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E9%A6%96"><span class="toc-text">回首</span></a></li></ol>
<blockquote>
<p>思来想去，我决定还是要写一篇文章分享一下我在网易的经历和生活，我对网易的观点或者想法以及评论也许并不是客观公正的，我只是想从一个校招生的角度来讲述。</p>
</blockquote>
<ul>
<li><p>2018 年 7 月 01 日，我从杭电毕业，进入了网易，从事大数据前端管理页面开发</p>
</li>
<li><p>2019 年 3 月 15 日，我主动离开了网易，一共 257 天、6168 小时、370080 分、22204800 秒。</p>
</li>
</ul>
<h2 id="心路历程"><a href="#心路历程" class="headerlink" title="心路历程"></a>心路历程</h2><p>进入网易后，我的心态也一点一点的发生着变化，这其中有一些是因为自己的原因，也有一部分是网易的原因，如果你愿意，我愿和你慢慢阐述</p>
<h3 id="意外-——-校招季拿到了网易-Offer"><a href="#意外-——-校招季拿到了网易-Offer" class="headerlink" title="意外 —— 校招季拿到了网易 Offer"></a>意外 —— 校招季拿到了网易 Offer</h3><p>我原本没想给网易投递 Offer，那个时候我心里只有阿里，至于原因么，有句话说的好，『所有的 Node 大佬不是在阿里，就去在去阿里的路上』，虽然我不是大佬，但是我也有一颗想成为技术大佬的心。那个时候我只投递了阿里的 Offer。</p>
<p>可是事与愿违，18 届的校招可谓说是及其严格，基本都是社招要求，而且听说就招了 300 人(只是听说)。投了两次阿里云，都以失败告终（毕竟我的朴神来阿里云）。这个时候正好有同学在网易实习，我就看了下，有前端岗位，那就去下试试吧。</p>
<p>说实话，那个时候对网易的前端、Node 没有抱有任何希望。网易在前端的开源社区几乎没有任何动静，也几乎从来没参加过任何技术论坛，也从来没听说他们有用任何前端框架，可以说对网易前端没有任何的概念。</p>
<p>面试的时候我也就啥都没准备，纯裸考，只是觉得这公司进不进无所谓吧，甚至 HR 面的时候，稍微顶撞了一下 HR，HR 问了一个问题，我回答了，结果他说我回答的不是他问的问题，我思考了一下，坚定的回了他一句『我回答的就是你的问题，那您不是想问这个？』。结果<strong>意外</strong>的，我竟然进了，我当时自己都蒙了。直到入职之后才回过神来，原来是他们太缺人了。。。</p>
<p>但是毕竟校招，怎么样还是要试一下么，就安慰自己说可能他们内部用的技术挺好的，只不过按照丁磊的作风，可能不喜欢招摇吧。但后来结果实力打脸，事与愿违~</p>
<p>说实话，当时也找过其他的公司，可是杭州这边，真正既有技术实力、有大佬助阵、面向开源的公司几乎少的可怜，除了阿里几乎找不到几个，于是当时在好朋友的推荐下，投了有赞的前端、七牛的后端。</p>
<p>七牛的后端笔试直接跪了，有赞的拿到了 offer，但是当时脑抽觉得有赞技术不好（另外是我和室友都拿到了有赞的 offer，但是前端的老大跟我的室友说带着他一起搞波大事情，和我却啥都没说，就加了个微信，我觉得受到了某种歧视），而且觉得有赞的平台有点小，于是给推了。</p>
<p>后来真正进入到网易之后，觉得网易还不如有赞呢。或许大家认识有赞是因为 996，都认为有赞 996 不好，可是有赞和普通的互联网企业一样，并没有 996，相反比其他公司还有活力，有各种兴趣组织，甚至还有官方的游戏比赛，Dota/王者，比赛还有专人解说呢。而且钱多福利好。而且杭州除了阿里能数上的有赞也是接入企业滴滴。</p>
<p>反正说了这么多，最终我算是说服自己，现在网易学习 1 年，然后去我喜欢的公司。</p>
<h3 id="期待-——-嗨，猪行动"><a href="#期待-——-嗨，猪行动" class="headerlink" title="期待 —— 嗨，猪行动"></a>期待 —— 嗨，猪行动</h3><p>期待着进入网易的生活会是什么样子；期待着会不会遇见很多大佬；期待着网易的食堂有多么好吃；期待着能不能和同事很好的相处；期待能不能用到自己喜欢的技术；期待着别人能不能承认自己的能力。</p>
<p>一切的期待，都在拿到校招 Offer 的那一刻开始。</p>
<p>这期间参加了 『嗨，猪行动』，第一次以校招的身份进入网易，我们在 HR 小哥哥小姐姐们的安排下，一起参加了一些有趣有意思的活动。大家分成各个小队，以小队的身份参加比赛，每完成一个比赛，都会有一定的积分奖励，在活动结束之后，可以去换取很多严选的礼物，比如有行李箱、抱枕、牙刷、拖鞋、杯子、笔等等。</p>
<p>我觉得这场活动最成功的便是在最后，来了一场上百人吃鸡游戏，在园区散落着很多盒子，每个盒子里面<strong>武器</strong>或者<strong>命</strong>，然后找到其他小队成员消灭之。虽然我们的枪只是简单的水枪，子弹也是可消除墨水，命只是一个简单的丝带绑在头上。而且我不得不承认这个游戏 Bug 太多，不过不得不说真的是很好玩的。</p>
<p>很快，虽然我很轻松的活到了前 10 名的样子，但是我是用某些不正常的方法（在某个门后躺着，假装自己已经死掉了，悠闲的等着；而且我们在这个游戏开始前就已经偷偷攒了好多武器和命，就是在玩吃鸡之前的游戏的时候），感觉不是太很公平，于是我就主动退出了。</p>
<p>静静的看着他们战斗，很快场上就只剩下 2 名妹子，一枚来自其他的组，还有一枚便是我们组的。于是最精彩的决赛来了，我们给他们腾出了场地，每人补足武器。</p>
<p>piupiupiu，piupiupiu，真的是太精彩了，我无法描述，但是结果有点遗憾，我们组的妹子惜败第二名。</p>
<p>一天如此开心，感谢 HR 小哥哥小姐姐们的辛勤付出，也感谢队友的努力奋斗，或许在此刻，我对网易的印象有了那么一些改变，感觉让人期待网易的生活会是怎么样子。</p>
<h3 id="满足-——-Mini-项目-『来人吖』"><a href="#满足-——-Mini-项目-『来人吖』" class="headerlink" title="满足 —— Mini 项目 『来人吖』"></a>满足 —— Mini 项目 『来人吖』</h3><p>2018 年 7 月 1 日，这一天终于到来了。我真正的不如了网易的大门，发现一切都是如想象的那么美好。</p>
<p>免费的四餐（包含夜宵喽），除了人太多以外味道还是很不错的；各种严选考拉的内购。有各种各样的折扣，而且有些还会直接在食堂门口摆摊。免费的班车简直不要太舒服，就是要每天 7 点半起床赶班车，真的是难受。园区免费停车、新能源免费充电，虽然这个时候我还没有买车，不过我已经在考虑中了。</p>
<p>入职之后，参加了 2 天的素质拓展，终于圆梦了我一直想去尝试的高空断桥，刺激、爽，还想再来一次。哈哈哈。</p>
<p>很快，最令我欣喜激动的事情来了，『Mini 项目』，简单点来讲，就是网易花了 100w 做了 8 个没啥用的产品。当然了，其实不是这样，重新讲一下，就是大家在一个月的时间里面，从<strong>零</strong>开始，做出一个可以上线的产品，从中体验整个产品的开发流程，学习工作中用到的技术栈，培养同学之间的合作意识。这其实是一个非常有意义的事情，从中你可以体会到创业的过程，需求分析、竞品分析、优势分析、未来产品规划、UI 设计、技术架构、团队合作、测试保证、产品推广，每一步都可谓非常有价值。</p>
<p>当然了，这其中最让我满足的便是我在 Mini 项目中担任了技术负责人的身份，终于可以满足我想玩各种技术的心，把各种想用的技术都集成在一起，话不多说，先申请 10 台机器走起，Docker Swarm;Kafka;Node.js;NestJs;小程序;mpvue;Redis;TiDB;ES;CI/CD;Spring Cloud，简直不要太爽。</p>
<p>让我最欣慰满足的是虽然我这个技术负责人当的不是很称职，但是大家不嫌弃，而且一起推动团队的进步，而且对我定下的技术方向没有太多的异议，尤其是后端龙哥定的微服务化的 Spring Cloud 框架简直不要太符合我的胃口。感觉大家都是有技术追求，热爱技术。</p>
<p>另外最爽的就是入职一个月的便天天加班，甚至有几次我都是凌晨 12 点下班，到家都 1 点了，第二天还要 7 点半爬起来赶班车，谢天谢地那个时候还有顺风车。即便如此，我并没有觉得加班有多累，因为我们都有一个共同的目标——产品上线，拿到第一。</p>
<p>哦顺便说一句，那个时候我们就是想做顺风车匹配，只不过我们是做拼滴滴车，简单来讲就是大家都是乘客，匹配到一起了，由其中一个人打滴滴，然后大家一起走。这样做最大的好处便是省钱，比如说我回家快车 80，拼车 60，如果找齐 4 人，便只要 20 快，甚至比顺风车还便宜，而且有快车的服务。但是即便如此，开始产品评审的时候，评委一直无法绕开滴滴顺风车这个大对手，也对我们的产品产生了质疑，而且我们在这期间也质疑过很多次，直到我们做完了之后没多久，2018 年 8 月，顺风车下架了，顺风车下架了，顺风车下架了，重要事情说三遍，我们这才意识到我们的产品是有多么正确，多么正确，多么正确。</p>
<h3 id="向往-——-就要步入真正的业务线去了"><a href="#向往-——-就要步入真正的业务线去了" class="headerlink" title="向往 —— 就要步入真正的业务线去了"></a>向往 —— 就要步入真正的业务线去了</h3><p>一个月的 Mini 项目结束之后，虽然我们并没有取得第一名，但是我们在这期间收获了更多的东西。</p>
<p>小组里面的每个人就要到对应的业务线去了，有去云信的，有去严选的，有去云音乐的，也有去 AI、安全部门的。虽然这些部门无一例外经历了裁员。</p>
<p>有了 Mini 项目的经历之后，我对接下来步入真正的工作充满了无比的向往，会不会他们也和我们的组员一样有着技术追求，我能不能发挥我自己最大的力量给项目贡献代码，能不能维护以为开源项目，能不能听到很多大佬们的讲座。</p>
<p>以前这些问题我是有所担心的，但是有了 Mini 项目的经历之后，我更相信我所说的。可是事实却是……</p>
<h3 id="愁-——-为什么和我想象的不一样，甚至说是非常非常非常不一样"><a href="#愁-——-为什么和我想象的不一样，甚至说是非常非常非常不一样" class="headerlink" title="愁 —— 为什么和我想象的不一样，甚至说是非常非常非常不一样"></a>愁 —— 为什么和我想象的不一样，甚至说是非常非常非常不一样</h3><p>可是事实却是事与愿违，进入部门之后，我才发现是我想多了。</p>
<p>有的时候我一直在吐槽说我们项目技术差，比如什么只能用 ES5；没有 webpack；没有测试；没有 CI；虽然是前后端分离，但是代码却和后端放在一个仓库里面；Git 提交没有规范，各种 pull merge；Git Message 也没有规范；……这是一个已经三年的项目了，而且最有意思的是原本开始的时候是孟导定的用 Regular，想兼容 IE。但是我问现在不是只兼容 Chrome 么，这是为啥呢？他们和我说原因就是因为 IE 实在是兼容不了。这个时候我真想说一句，这个理由真的很棒。</p>
<p>这个问题不仅仅体现在前端，后端也是有如此的问题，觉得只要能解决问题就好了，要什么格式，要什么技术追求。这碗面条（代码）我只要保证计算机能吃就行，乱成啥样关我啥事。我只说一句，看了后端 Java 代码，我是第一次见识到 Space 和 Tab 缩进同时使用的，牛啤。</p>
<p>我甚至还开过一个玩笑说，前端越来越追求规范，开始越来越多的使用 TS 强类型的语言，而后端却想着如果绕开 Java 类型限定，内部几乎都是 JSONObject。当然这是一句玩笑，毕竟有些框架的东西你是没法直接用 JSONObject 的，但也能反映一些问题。</p>
<p>愁啊愁啊，当初的期待全部破灭，想推重构，可是我一个刚入职的又如何推的动？</p>
<p>愁啊愁啊，不仅仅是因为技术，而且内部其他的问题也很多，比如说 QA 测试问题、产品乱接需求、文档书写不全。。。夸张点说，我的大学技术社团除了干活没钱、人力不足以外，算是吊打我们部门，至少从技术上是这么讲的。至少社团的服务器环境是全 Docker 化的。都 9102 年了，还不会用 Docker 是来搞笑的么……</p>
<p>更愁的是，网易似乎不接受内部的合作，我曾经给网易云写了一个更好用对象存储 Node.js SDK，<a target="_blank" rel="noopener" href="https://github.com/XGHeaven/nos-node-sdk">nos-node-sdk</a>，想合并到他们的代码库里面，结果他们一直不给我回复。问他们为啥不改进代码，他说人手不够……我 go……我帮你写了，我帮你维护还不乐意啊，再说我就不吐槽你们的文档写的有多差了，错误一片一片的，也就我愿意认认真真的看下来了。</p>
<h3 id="迷茫-——-完全看不到方向"><a href="#迷茫-——-完全看不到方向" class="headerlink" title="迷茫 —— 完全看不到方向"></a>迷茫 —— 完全看不到方向</h3><p>时间一久，我就陷入了迷茫期，找不到未来发展的方向，就像是我周围的同学都在踏步前进，有研究 Node 内核的，有使用 Egg 开发后台的，有用 React+Antd 的，还有 Typescript 写 IOS 组件的。而我，现在只能看着 Regular，对未来几乎没有任何帮助。换句话说，他们所在的环境至少给他们拓宽了不少眼界，而网易却没给我拓宽任何的眼界。</p>
<p>我也在安慰自己，毕竟学习是自己的事情，公司不给力，只能靠我们自己啦。确实我也在不停的努力，尝试学习其他的东西，可是这种学习毕竟是没有方向性的，我现在缺的是项目经历，而不是基础。基础就像是地基，只要地基够用，如何快速搭建起高楼是最重要的，而不是说连高楼都没造起来的时候想着拓宽地基。</p>
<p>另外，你见过那个专家是可以脱离他们的环境的？工作不用 React，却想成为 React 专家；工作不用 Java，却想成为 Java 专家；工作不接触 Node 内核，怎么成为 Node 专家；工作不接触浏览器内核；怎么成为浏览器专家。<strong>一个公司的天花板牵扯着你能早就多高的喽，也能让你知道你现在的基础够不够用，如何更好的提高自己。</strong>自我驱动的学习最大的用处是帮你补足基础，而只有真正的项目经历，才能真正让你有质的成长。</p>
<p>但是，这些东西在网易，很难寻得。</p>
<p>也许有人会出来说，网易里面技术栈也是很多的，React/Vue 都是有的。确实，有的确有，可能这又能如何？况且使用这部分技术的人也是少之又少，最关键的还是人！</p>
<h3 id="离开-——-却没有任何留念"><a href="#离开-——-却没有任何留念" class="headerlink" title="离开 —— 却没有任何留念"></a>离开 —— 却没有任何留念</h3><p>最终我选择了离开网易，去寻找新的家园。</p>
<p>当我真正离开的时候，我才发现原来网易并不是那么的不堪。有的地方还是有许多值得学习借鉴的地方，可惜对于我们这些下层人民来讲，上层优秀的想法无法渗透到我们这里，在我们眼里，网易只是一个完成需求就可以下班的地方，不需要你有太多的想法，只需要按照上面的指示一步一步来做就可以了。</p>
<p>难得说网易的福利好，可惜我并没有沾上多少，食堂 Mini 项目之后我就搬离本部园区，在外面写字楼包了一块办公区，所以食堂基本吃不上了；免费停车就更不用说了，只能停本部，然后走一公里到我的工作地点；内部的技术分享全在园区，根本没时间赶过去，只能在线上看看了；各种摆摊更别说看见了；网易二期别人都搬过去了，为啥我们还不搬。简单点来讲，我培养不了我对网易的感情，对我来我，我就像是给大公司做外包，那我为啥不去一个钱多技术好的公司呢。</p>
<p>离开的时候，最大的愧疚便是对 HR 们，愧对了你们对我们的培养，真的真的真的非常抱歉，路过 HR 办公区的时候，害怕你看到我，虽然你还是看到了我。不过我们是主动离职的，比被裁的要好一点点，可惜就是没钱拿。</p>
<p>但是，这并不能阻止我离开网易。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><ul>
<li><p>感谢陪伴和我一起走过 mini 项目的同学们</p>
</li>
<li><p>感谢导师的帮助</p>
</li>
<li><p>感谢身边的同事们</p>
</li>
<li><p>最最感谢校招 HR 小姐姐小哥哥们的努力，为你们实力打 Call。感谢你们对我们的照顾和指导，让我们更快的融入到了网易的大世界中。谢谢，谢谢，尤其感谢森森和 6 姐。</p>
</li>
</ul>
<h2 id="回首"><a href="#回首" class="headerlink" title="回首"></a>回首</h2><p>现在我入职了字节跳动，现在回过头来看了看，对我来说，这真的算是一个非常正确的决定，我也就不吐槽网易跟字节跳动相比的基础设施有多差了，我也不吐槽网易有多扣了。</p>
<p>如果你现在问我推不推荐网易，我觉得还是值得推荐的，但是一定一定一定要看部门，一定一定一定要看 Leader，一定一定一定要看环境。看部门有没有发展前景，看 Leader 愿不愿意培养自己，看环境会不会限制到你的天花板。</p>
<p>另外这里实力打 Call 考拉前端，足够开放，也有大佬，如果真的去可以去这个部门。当然严选的就是有点封闭了，搞了一套很不错的 npm 私有仓库，权限系统也做了，却不尝试在公司内部推广，搞不懂。云音乐和严选差不多，这里又要吐槽一下内部的 nei 是好难用，不仅仅是 ui 丑，而且这么久了，才上线在线 mock 功能，还不支持 swagger 导入，还不如之前我实习的公司大搜车推出的 easy-mock 呢。</p>
<p>过去就是过去，迎接未来，至少字节跳动能给我保证多劳多得，这就足够了！！！</p>
<p>另外说一句，有想要内推字节跳动的学弟学妹么，社招也可以哦，请用简历砸我吧，<a href="mailto:xutianyang.bradley@bytedance.com">xutianyang.bradley@bytedance.com</a>，如果想要和我交流的话，可以 Telegram 找我，@xgheaven。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/03/12/257-days-in-netease/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/12/29/how-to-handle-controlled-uncontrolled-component-in-react/">
                            可控组件？不可控组件？让我们来讨论一下下~
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Sat Dec 29 2018 00:00:00 GMT+0800">
	
		    12月 29, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Frontend/">Frontend</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%AF%E6%8E%A7%E5%92%8C%E4%B8%8D%E5%8F%AF%E6%8E%A7%EF%BC%9F"><span class="toc-text">什么是可控和不可控？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E5%95%A5%E8%A6%81%E5%8C%BA%E5%88%86%E5%91%A2%EF%BC%9F"><span class="toc-text">为啥要区分呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#value-defaultValue-onChange"><span class="toc-text">value? defaultValue? onChange?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#propName-in-this-props%EF%BC%9F"><span class="toc-text">propName in this.props？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Independence"><span class="toc-text">Independence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-text">如何使用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
<blockquote>
<p>前言：本人入职之后算是第一次真正去写 React，发现了 React 的组件系统和其他框架的组件系统有些许的不同，这也触发了我对其中组件的可控性的一些思考和总结。</p>
</blockquote>
<p>自从前端有了组件系统之后，有一个很常见但是却又被大家忽视的概念，就是可控组件（Controlled Component）和不可控组件（Uncontrolled Component）。</p>
<h3 id="什么是可控和不可控？"><a href="#什么是可控和不可控？" class="headerlink" title="什么是可控和不可控？"></a>什么是可控和不可控？</h3><p>官方详细讲解了什么事可控和不可控组件，虽然只是针对 <code>input</code> 组件的 <code>value</code> 属性来讲的。但是对于很多第三方组件库来讲，一个组件不止有一个数据属于可控。比如 Ant Design 的 <code>Select</code> 组件，<code>value</code> 和 <code>open</code> 都属于可控的数据，如果你让 value 可控 open 不可控，那这到底是可控组件还是不可控组件呢？</p>
<p>所以从广义来讲使用可控/不可控组件其实不是很恰当，这里使用<strong>可控数据</strong>与<strong>不可控数据</strong>更加合理一点。一个组件可能可能同时有可控的数据和不可控的数据。</p>
<p><strong>可控数据</strong>是指组件的<strong>数据</strong>被使用者所控制。<strong>不可控数据</strong>是指组件的<strong>数据</strong>不由使用者来控制而是由组件内部控制。</p>
<p>之所以会有可控和不可控，主要是跟人奇怪的心理有关。如果把框架比作一个公司，组件比作人，组件之间的关系比作上下级。那么上级对下级的期望就是你既能自己做好分内的事情，也可以随时听从我的命令。这本身就是一件矛盾的事情，一边撒手不管，一边又想全权掌控。遇到这样的上级，下级肯定会疯了吧。</p>
<h3 id="为啥要区分呢？"><a href="#为啥要区分呢？" class="headerlink" title="为啥要区分呢？"></a>为啥要区分呢？</h3><p>在 Vue 中，其实都忽视了这两者的区别，我们来看下面这个例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input/&gt;</span><br></pre></td></tr></table></figure>
<p>上面是一个最简单 Input 组件，我们来思考一下如下几种使用场景：</p>
<ul>
<li><p>如果我只关心最后的结果，也就是输入的值，中间的过程不关心，最简单的方式是用 <code>v-model</code> 或者自己在 <code>change</code> 事件里面获取值并保存下来。<br>这种场景是非常普遍，Vue 可以很好的完成，结果也符合人们的预期。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;input v-model=<span class="string">&quot;value&quot;</span>/&gt;</span><br><span class="line">&lt;!-- <span class="variable constant_">OR</span> --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> @<span class="attr">change</span>=<span class="string">&quot;change&quot;</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我也只是关心结果，但是想要一个初始值。 也很简单，通过 value 传入一个静态字符串不就好了，或者传入一个变量，因为 Vue 的 props 是单向的。<br>其中第三个方案并不是非常正确的方式，如果 <code>initValue</code> 在用户输入期间发生了更新，那么他将覆盖用户的数据，且不会触发 <code>change</code> 事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;input v-model=<span class="string">&quot;value&quot;</span>/&gt; &lt;!-- value 有初始值 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;init string&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;change&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">:value</span>=<span class="string">&quot;initValue&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;change&quot;</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我不仅仅关心结果，还关心过程，我需要对过程进行控制。比如说把输入的字符串全部大小写，或者锁定某些字符串。 熟练的工程师肯定可以写出下面的代码。<br>但是这会有问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input v-model=<span class="string">&quot;value&quot;</span>/&gt; &lt;!-- watch <span class="string">&quot;value&quot;</span>，做修改 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">:value</span>=<span class="string">&quot;value&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;change&quot;</span>/&gt;</span></span> &lt;!-- 在 change 中修改数据 --&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>数据的修改都是在渲染 dom 之后，也就是说你不管怎么处理，都会出现输入的抖动。</p>
</li>
<li><p>如果通过第二种方法，恰巧你做的工作是限制字符串长度，那么你这样写 <code>change(e) &#123;this.value = e.target.slice(0, 10)&#125;</code> 函数会发现没有效果。这是因为当超过 10 字符之后，value 的值长度一直是 10，vue 没有检测到 value 的变化，从而不会更新 input.value。</p>
</li>
</ol>
</li>
</ul>
<p>出现这个问题最关键的是因为没有很好的区分可控组件和不可控组件，我们来回顾一下上面的某一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input :value=<span class="string">&quot;value&quot;</span> @change=<span class="string">&quot;change&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>你能从这块代码能看出来使用这个组件的用户的意图是什么呢？他是想可控的使用组件还是说只是想设置一个初始值？你无法得知。我们人类都无法得知，那么代码层面就不可能得知的了。所以 vue 对这一块的处理其实是睁一只眼闭一只眼。用户用起来方便，</p>
<p>用一个例子来简单描述一下：上级让你去做一项任务，你询问了上级关于这些任务的信息（props），然后你就开始（初始化组件）工作了，并且你隔一段时间就会向上级汇报你的工作进度（onChange），上级根据你反馈的进度，合理安排其他的事情。看起来一切都很完美。但是有的上级会有比较强的控制欲，当你提交了你的工作进度之后，他还会瞎改你的工作，然后告诉你，按照我的继续做。然后下级就懵逼，当初没说好我要接受你的修改的呀（value props），我这里也有一份工作进度呀（component state），我应该用我自己的还是你的？</p>
<p>对于人来说，如何处理上级的要求（props）和自身工作（state）是一个人情商的表现，这个逻辑很符合普通人的想法，但是对于计算机来说，它没有情商也无法判断究竟应该听谁的。为了克服这个问题，你需要多很多的判断和处理才可以，而且对于一些不变的值，你需要先清空再 nextTick 之后赋值才可以出发组件内部的更新。</p>
<p>最近入职之后，公司用到了 React，我才真正的对这个有所理解。</p>
<h3 id="value-defaultValue-onChange"><a href="#value-defaultValue-onChange" class="headerlink" title="value? defaultValue? onChange?"></a>value? defaultValue? onChange?</h3><blockquote>
<p>如果对 React 可控组件和不可控组件有了解了可以跳过这块内容了。</p>
</blockquote>
<p>让我们来看一下 React 如何处理这个的？我们还是拿上面的那三种情况来说：</p>
<ul>
<li><p>如果我只关心最后的结果，也就是输入的值，中间的过程不关心</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onChange=&#123;onChange&#125;/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我也只是关心结果，但是想要一个初始值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input defaultValue=<span class="string">&quot;init value&quot;</span> onChange=&#123;onChange&#125;/&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">defaultValue</span>=<span class="string">&#123;initValue&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;onChange&#125;/</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我不仅仅关心结果，还关心过程，我需要对过程进行控制</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input value=&#123;value&#125; onChange=&#123;onChange&#125;/&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>当看完了这段你会很清楚的知道什么样的结构是可控，什么结构是不可控：</p>
<ul>
<li><p>如果有 <code>value</code> 那么就属于可控数据，永远使用 <code>value</code> 的值</p>
</li>
<li><p>否则属于不可控数据，由组件使用内部 <code>value</code> 的值，并且通过 <code>defaultValue</code> 设置默认值</p>
</li>
</ul>
<p>不论什么情况修改都会触发 <code>onChange</code> 事件。</p>
<p>React 对可控和不可控的区分其实对于计算机来说是非常合理的，而且也会让整个流程变的非常清晰。当然，不仅仅只有这一种设置的方式，你可以按照一定的规则也同样可以区分，但是<strong>保证可控和不可控之间清晰的界限是一个好的设计所必须要满足的</strong>。</p>
<h3 id="propName-in-this-props？"><a href="#propName-in-this-props？" class="headerlink" title="propName in this.props？"></a><code>propName</code> in this.props？</h3><p>了解上面的概念之后，我们进入到实战环节，我们怎么从代码的层面来判断当前组件是可控还是不可控呢？</p>
<p>根据上面的判断逻辑来讲：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isControlled1 = <span class="string">&#x27;value&#x27;</span> <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">props</span> <span class="comment">// approval 1</span></span><br><span class="line"><span class="keyword">const</span> isControlled2 = !!<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">value</span> <span class="comment">// approval 2</span></span><br><span class="line"><span class="keyword">const</span> isControlled3 = <span class="string">&#x27;value&#x27;</span> <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">props</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">value</span> !== <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">value</span> !== <span class="literal">undefined</span> <span class="comment">// approval 3</span></span><br></pre></td></tr></table></figure>
<p>我们来观察上面几个判断的方式，分别对应一下下面几个模板（针对第三方组件）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Input</span> value=&#123;inputValue&#125; /&gt; <span class="comment">// element 1，期望可控</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Input</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span> <span class="comment">// element 2，期望可控</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span> <span class="comment">// element 3，期望不可控</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Input</span> <span class="attr">value</span>=<span class="string">&#123;null&#125;</span> /&gt;</span></span> <span class="comment">// element 4，期望？？？</span></span><br></pre></td></tr></table></figure>
<p>可以得到如下表格</p>
<table>
<thead>
<tr>
<th>是否可控</th>
<th>approval 1</th>
<th>approval 2</th>
<th>approval 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>element1</td>
<td><code>true</code></td>
<td><code>true</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>element2</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>element3</td>
<td><code>false</code></td>
<td><code>false</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>element4</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>false</code></td>
</tr>
</tbody>
</table>
<p>大家第一眼就应该能看出来方法二其实是不正确的，他无法很好的区分这两种状态，所以直接 pass 掉。</p>
<p>眼尖的同学也会发现为什么 element 4 的期望没有填写呢？这是因为有一条官方的规则没有讲，这条规则是这样的：<strong>当设置了 </strong><code>**value**</code><strong> 属性之后，组件就变成了可控组件，会阻止用户修改 input 的内容。但是如果你想在设置了 </strong><code>**value**</code><strong> prop 的同时还想让用户可以编辑的话，只可以通过设置 </strong><code>**value**</code><strong> 为 </strong><code>**undefined**</code><strong> 或 </strong><code>**null**</code><strong>。</strong></p>
<p>在官方的这种规则下面，element 4 期望是不可控组件，也就是说 approval 3 是完全符合官方的定义的。但是这样会导致可控和不可控之间的界限有些模糊。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Input</span> value=&#123;inputValue&#125; /&gt;</span><br><span class="line"><span class="comment">// 如果 inputValue 是 string，组件是什么状态？如果是 null 又是什么状态？</span></span><br></pre></td></tr></table></figure>
<p>所以这里其实我推荐使用 approval 1 的方式，这也是 antd 所采用的。虽然不符合官方的定义，但是我觉得符合人们使用组件的一种直觉。第六感，=逃=</p>
<h3 id="Independence"><a href="#Independence" class="headerlink" title="Independence"></a>Independence</h3><p>有了判断的方法，那么我们可以画出一个简单的流程图（Input 组件为例）：</p>
<img src="/2018/12/29/how-to-handle-controlled-uncontrolled-component-in-react/50183dbb-310c-4fb0-aa48-ae85922cd5a1.jpg" class="">
<p>图片有点复杂，简单来讲就是每一次需要获取可控数据或者更新可控数据的时候，都需要检测一下当前组件的状态，并根据状态选择是从 props 中获取数据还是从 state 中获取数据已经更新的时候调用的是那个函数等等。图中有一些箭头的方向不是很正确，而且部分细节未画出，大家见谅。</p>
<p>如果只是添加这一个可控的属性 <code>value</code> ，这样写未尝不可，但是如果我们要同时考虑很多属性呢？比如说 Antd Select 组件就同时有 <code>value</code> 和 <code>open</code> 两个可控属性，那么整个代码量是以线性方式增长的。这很明显是无法接受的。</p>
<p>于是这里我引入了 Independence 装饰器来做这件事情。架构如下：</p>
<img src="/2018/12/29/how-to-handle-controlled-uncontrolled-component-in-react/7dcb5c16-4e65-4239-8e5e-6d06db4a92ce.jpg" class="">
<p>我们可以这么理解，一个支持可控和不可控的组件本质上可以拆分成内部一个展示型的无状态受控的组件和外面的包装组件，通过包装（也就是高阶组件的方式）让内部受控组件支持不可控。</p>
<p>这样写其实有如下几个好处：</p>
<ol>
<li><p>组件逻辑复杂度降低，只需要将组件的受控情况</p>
</li>
<li><p>可以将任意受控组件包装成不受控组件，尤其是对第三方组件的封装上</p>
</li>
<li><p>组件复杂度降低，代码冗余变少</p>
</li>
<li><p>非常方便的添加和删除受控属性，只需要修改装饰器即可</p>
</li>
</ol>
<h3 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a>如何使用？</h3><p>目前我简单实现了 Independence 装饰器，代码在网易猛犸开源的组件库 <a target="_blank" rel="noopener" href="https://github.com/Mammut-FE/bdms-ui">bdms-ui</a>（建设中，组件不全、文档不全、时间不够，敬请期待）中，<a target="_blank" rel="noopener" href="https://github.com/Mammut-FE/bdms-ui/blob/master/src/lib/independence.tsx">代码在此</a>。</p>
<p>他遵循这样的规范：<strong>假如属性名称为 </strong><code>**value**</code><strong>，那么默认值为 </strong><code>**defaultValue**</code><strong>，change 事件为 </strong><code>**onValueChange**</code>。支持通过 <code>onChangeName</code> 修改 change 事件名称，通过 <code>defaultName</code> 修改默认值名称。</p>
<p>另外最简单的使用方式就是通过装饰器了，拿 <code>Select</code> 组件举例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Independence</span>(&#123;</span><br><span class="line">    <span class="attr">value</span>: &#123;</span><br><span class="line">        <span class="attr">onChangeName</span>: <span class="string">&#x27;onChange&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">open</span>: &#123;&#125; <span class="comment">// 使用默认值</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Select</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="comment">// blahblah，你就可以当受控组件来编写了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从此编写可控和不可控的数据从未如此简单。另外 Independence 还实现了 forward ref 的功能。</p>
<p>不过现在功能还比较薄弱，需要经过时间的检验，等完备之后可以封装成一个库。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文简单讲解了一下什么是可控和不可控，以及提出了一个 React 的解决方案。</p>
<p>这些只是基于我的经验的总结，欢迎大家积极交流。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/12/29/how-to-handle-controlled-uncontrolled-component-in-react/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/12/26/react-hook-with-parcel-to-build-truth-or-dare/">
                            尝鲜用 React Hook + Parcel 构建真心话大冒险简单页面
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Wed Dec 26 2018 00:00:00 GMT+0800">
	
		    12月 26, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Frontend/">Frontend</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useState-%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%8E%A5%E8%A7%A6%E7%9A%84-Hook"><span class="toc-text">useState 第一个接触的 Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEffect-%E7%9B%91%E5%90%AC%E5%BC%80%E5%A7%8B%E5%92%8C%E7%BB%93%E6%9D%9F%E4%BA%8B%E4%BB%B6"><span class="toc-text">useEffect 监听开始和结束事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-Hook"><span class="toc-text">其他 Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E6%9D%A5%E7%94%A8-Emotion-%E5%8A%A0%E7%82%B9%E6%A0%B7%E5%BC%8F"><span class="toc-text">我们来用 Emotion 加点样式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E5%B0%BE"><span class="toc-text">收尾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%A4%8D%E7%9B%98-%E2%80%94%E2%80%94-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-text">总结复盘 —— 性能问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
<blockquote>
<p>阅读推荐：本人需要您有一定的 React 基础，并且想简单了解一下 Hook 的工作方式和注意点。但是并不详细介绍 React Hook，如果想有进一步的了解，可以查看官方文档。因为项目比较简单，所以我会比较详细的写出大部分代码。建议阅读文章之前请先阅读目录找到您关注的章节。</p>
</blockquote>
<p>几天前，我女票和我说他们新人培训需要一个《真心话大冒险》的界面，想让我帮她写一个。我说好呀，正好想到最近的 React Hook 还没有玩过，赶紧来试试，于是花了一个晚上的时间，其实是俩小时，一个小时搭建项目，一个小时写。</p>
<p>Demo: <a target="_blank" rel="noopener" href="http://souche-truth-or-dare.surge.sh/">http://souche-truth-or-dare.surge.sh</a> (因为女票是大搜车的)</p>
<img src="/2018/12/26/react-hook-with-parcel-to-build-truth-or-dare/87c811c3-47f9-42a1-a98e-dc97d0f9d82b.gif" class="">
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>首先我们创建一个文件夹，做好初始化操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir truth-or-darecd truth-or-darenpm init -y</span><br></pre></td></tr></table></figure>
<p>安装好依赖，<code>react@next</code> <code>react-dom@next</code> <code>parcel-bundler</code> <code>emotion@9</code> <code>react-emotion@9</code> <code>babel-plugin-emotion@9</code>。</p>
<blockquote>
<p>React Hook 截止发稿前（2018-12-26）还处于测试阶段，需要使用 next 版本。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i react@next react-dom@next emotion@9 react-emotion@9npm i parcel-bundler babel-plugin-emotion@9 -D</span><br></pre></td></tr></table></figure>
<p>创建 <code>.babelrc</code> 文件或者在 <code>package.json</code> 中写入 Babel 配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;plugin&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">[</span><span class="string">&quot;emotion&quot;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>创建 <code>src</code> 文件夹，并创建 <code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>真心话大冒险<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.jsx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>和 <code>index.jsx</code> 文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>First Render<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>最后添加如下 <code>scripts</code> 到 <code>package.json</code> 中</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;parcel serve src/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rm -rf ./dist &amp;&amp; parcel build src/index.html&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>最后我们就可以 <code>npm start</code> 就可以成功启动开发服务器了。在浏览器中打开 <code>localhost:1234</code> 即可。</p>
<p><code>parcel</code> 已经内建了 Hot Reload，所以不需要进行额外的配置，开箱即用。是不是觉得非常简单，有了它，手动搭建项目不再困难。当然了，TS 也是开箱即用的，不过这次我这个项目真的很小，就不用 TS 了。</p>
<h3 id="useState-第一个接触的-Hook"><a href="#useState-第一个接触的-Hook" class="headerlink" title="useState 第一个接触的 Hook"></a>useState 第一个接触的 Hook</h3><p>我们创建一个 <code>App.jsx</code> 开始我们真正的编码。先简单来看一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [selected, setSelected] = <span class="title function_">useState</span>(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> [started, setStarted] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;selected&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span>&gt;</span>&#123;started ? &#x27;结束&#x27; : &#x27;开始&#x27;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们就完成了对 Hook 最简单的使用，当然了现在还没有任何交互效果，也许你并不明白这段代码有任何用处。</p>
<p>简单讲解一下 useState，这个函数接受一个参数，为初始值，可以是任意类型。它会返回一个 <code>[any, (v: any) =&gt; void]</code> 的元组。其中第一个 State 的值，另一个是一个 Setter，用于对 State 设置值。</p>
<p>这个 Setter 我们如何使用呢？只需要在需要的地方调用他就可以了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;<span class="function">() =&gt;</span> <span class="title function_">setStarted</span>(!started)&#125;&gt;&#123;started ? <span class="string">&#x27;结束&#x27;</span> : <span class="string">&#x27;开始&#x27;</span>&#125;&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<p>保存，去页面点击一下这个按钮看看，是不是发现他会在 <code>结束</code> 和 <code>开始</code> 之间切换？Setter 就是这么用，非常简单，如果用传统的 Class Component 来理解的话，就是调用了 <code>this.setState(&#123;started: !this.state.started&#125;)</code> 。不过和 setState 不同的是，Hook 里面的所有数据比较都是 <code>===</code>（严格等于）。</p>
<p>useState 还有很多用法，比如说 Setter 支持接收一个函数，用于传入之前的值以及返回更新之后的值。</p>
<h3 id="useEffect-监听开始和结束事件"><a href="#useEffect-监听开始和结束事件" class="headerlink" title="useEffect 监听开始和结束事件"></a>useEffect 监听开始和结束事件</h3><p>接下来，我们想要点击开始之后，屏幕上一直滚动，直到我点击结束。</p>
<p>如果这个需求使用 Class Component 来实现的话，是这样的：</p>
<ol>
<li><p>监听按钮点击事件</p>
</li>
<li><p>判断是开始还是结束</p>
<ul>
<li><p>如果是开始，那么就创建一个定时器，定时从数据当中随机获取一条真心话或大冒险并更新 <code>selected</code></p>
</li>
<li><p>如果是结束，那么就删除之前设置的定时器</p>
</li>
</ul>
</li>
</ol>
<p>非常直接，简单粗暴。</p>
<p>用了 Hook 之后，当然也可以这样做了，不过你还需要额外引入一个 State 来存储 timer，因为函数组件无法持有变量。但是如果我们换一种思路：</p>
<ol>
<li><p>监听 <code>started</code> 变化</p>
<ul>
<li><p>如果是开始，那么创建一个定时器，做更新操作</p>
</li>
<li><p>如果是结束，那么删除定时器</p>
</li>
</ul>
</li>
</ol>
<p>好像突然变简单了，让我们想象这个用 Class Component 怎么实现呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">_, preState</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">started</span> !== preState.<span class="property">started</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">started</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="built_in">setInterval</span>(<span class="comment">/* blahblah*/</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timer</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// blahblah</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好麻烦，而且逻辑比较绕，而且如果 componentDidUpdate 与 render 之间有非常多的代码的时候，就更难对代码进行分析和阅读了，如果你后面维护这样的代码，你会哭的。可是用 useEffect Hook 就不一样了。画风如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 之前的代码</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当 started 变化的时候，调用传进去的回调</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (started) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setSelected</span>(<span class="title function_">chooseOne</span>())</span><br><span class="line">      &#125;, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [started])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 返回的 View</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当用了 React Hook 之后，所有的逻辑都在一起了，代码清晰且便于阅读。</p>
<p>useEffect 从字面意义上来讲，就是可能会产生影响的一部分代码，有些地方也说做成副作用，其实都是没有问题的。但是副作用会个人一种感觉就是这段代码是主动执行的而不是被动执行的，不太好理解。我觉得更好的解释就是受到环境（State）变化影响而执行的代码。</p>
<p>为什么这么理解呢？你可以看到 useEffect 还有第二个参数，是一个数组，React 会检查这个数组这次渲染调用和上次渲染调用（因为一个组件内可能会有多次 useEffect 调用，所以这里加入了<strong>渲染</strong>限定词）里面的每一项和之前的是否变化，如果有一项发生了变化，那么就调用回调。</p>
<p>当理解了这个流程之后，或许你就能理解为什么我这么说。</p>
<p>当然了，第二个参数是可以省略的，省略之后就相当于默认监听了全部的 State。（现在你可以这么理解，但是当你进一步深入之后，你会发现不仅仅有 State，还有 Context 以及一些其他可能触发状态变化的 Hook，本文不再深入探究）</p>
<p>到现在，我们再来回顾一下关于定时器的流程，先看一下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (started) &#123;</span><br><span class="line">  <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setSelected</span>(<span class="title function_">chooseOne</span>())</span><br><span class="line">  &#125;, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理想的流程是这样的：</p>
<ul>
<li><p>如果开始，那么注册定时器。——Done!</p>
</li>
<li><p>如果是结束，那么取消定时器。——Where?</p>
</li>
</ul>
<p>咦，<code>else</code> 的分支去哪里了？为啥在第一个分支返回了取消定时器的函数？</p>
<p>这就牵扯到 useEffect 的第二个特性了，他不仅仅支持做正向处理，也支持做反向清除工作。你可以返回一个函数作为清理函数，当 effect 被调用的时候，他会先调用上次 effect 返回的清除函数（可以理解成析构），然后再调用这次的 effect 函数。</p>
<p>于是我们轻松利用这个特性，可以在只有一条分支的情况下实现原先需要两条分支的功能。</p>
<h3 id="其他-Hook"><a href="#其他-Hook" class="headerlink" title="其他 Hook"></a>其他 Hook</h3><p>在 Hook 中，上面两个是使用非常频繁的，当然还有其他的比如说 <code>useContext</code>/<code>useReducer</code>/<code>useCallback</code>/<code>useMemo</code>/<code>useRef</code>/<code>useImperativeMethods</code>/<code>useLayoutEffect</code>。</p>
<p>你可以创建自己的 Hook，在这里 React 遵循了一个约定，就是所有的 Hook 都要以 <code>use</code> 开头。为了 ESLint 可以更好对代码进行 lint。</p>
<p>这些都属于高级使用，感兴趣的可以去研究一下，本片文章只是入门，不再过多讲解。</p>
<h3 id="我们来用-Emotion-加点样式"><a href="#我们来用-Emotion-加点样式" class="headerlink" title="我们来用 Emotion 加点样式"></a>我们来用 Emotion 加点样式</h3><p>css-in-js 大法好，来一顿 Duang, Duang, Duang 的特技就好了，代码略过。</p>
<h3 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h3><p>重新修改 <code>src/index.jsx</code> 文件，将 <code>&lt;div/&gt;</code> 修改为 <code>&lt;App/&gt;</code> 即可。</p>
<p>最后的 <code>src/App.jsx</code> 文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> styled <span class="keyword">from</span> <span class="string">&#x27;react-emotion&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lists = [</span><br><span class="line">  <span class="string">&#x27;说出自己的5个缺点&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;绕场两周&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;拍一张自拍放实习生群里&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;成功3个你说我猜&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;记住10个在场小伙伴的名字&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;大声说出自己的名字“我是xxx”3遍&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;拍两张自拍放实习生群里&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;选择另一位小伙伴继续游戏&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;直接通过&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;介绍左右两个小伙伴&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">chooseOne</span>(<span class="params">selected</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> n = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    n = lists[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * lists.<span class="property">length</span>)]</span><br><span class="line">  &#125; <span class="keyword">while</span>( n === selected)</span><br><span class="line">  <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Root</span> = styled.<span class="property">div</span><span class="string">`</span></span><br><span class="line"><span class="string">  background: #FF4C19;</span></span><br><span class="line"><span class="string">  height: 100vh;</span></span><br><span class="line"><span class="string">  width: 100vw;</span></span><br><span class="line"><span class="string">  text-align: center;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Title</span> = styled.<span class="property">div</span><span class="string">`</span></span><br><span class="line"><span class="string">  height: 50%;</span></span><br><span class="line"><span class="string">  font-size: 18vh;</span></span><br><span class="line"><span class="string">  text-align: center;</span></span><br><span class="line"><span class="string">  color: white;</span></span><br><span class="line"><span class="string">  padding: 0 10vw;</span></span><br><span class="line"><span class="string">  font-family:&quot;Microsoft YaHei&quot;,Arial,Helvetica,sans-serif,&quot;宋体&quot;;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Button</span> = styled.<span class="property">button</span><span class="string">`</span></span><br><span class="line"><span class="string">  outline: none;</span></span><br><span class="line"><span class="string">  border: 2px solid white;</span></span><br><span class="line"><span class="string">  border-radius: 100px;</span></span><br><span class="line"><span class="string">  min-width: 120px;</span></span><br><span class="line"><span class="string">  width: 30%;</span></span><br><span class="line"><span class="string">  text-align: center;</span></span><br><span class="line"><span class="string">  font-size: 12vh;</span></span><br><span class="line"><span class="string">  line-height: 20vh;</span></span><br><span class="line"><span class="string">  margin-top: 15vh;</span></span><br><span class="line"><span class="string">  color: #FF4C19;</span></span><br><span class="line"><span class="string">  cursor: pointer;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [selected, setSelected] = <span class="title function_">useState</span>(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> [started, setStarted] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">onClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">setStarted</span>(!started)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (started) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setSelected</span>(<span class="title function_">chooseOne</span>(selected))</span><br><span class="line">      &#125;, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [started])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Root</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Title</span>&gt;</span>&#123;selected&#125;<span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Button</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>&#123;started ? &#x27;结束&#x27; : &#x27;开始&#x27;&#125;<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="总结复盘-——-性能问题？"><a href="#总结复盘-——-性能问题？" class="headerlink" title="总结复盘 —— 性能问题？"></a>总结复盘 —— 性能问题？</h3><p>最近刚刚转正答辩，突然发现<strong>复盘</strong>这个词还挺好用的，哈哈哈。</p>
<p>虽然这么短时间的使用，还是有一些自己的思考，说出来供大家参考一下。</p>
<p>如果你仔细思考一下会发现，当使用 useEffect 的时候，其实每次都是创建了一个新的函数，但并不是说每次都会调用这个函数。如果你代码里面 useEffect 使用的很多，而且代码还比较长，每次渲染都会带来比较大的性能问题。</p>
<p>所以解决这个问题有两个思路：</p>
<ol>
<li><p>不要在 Hook 中做太多的逻辑，比如说可以让 Hook 编写一些简单的展示组件，比如 Tag/Button/Loading 等，逻辑不复杂，代码量小，通过 Hook 写在一起可以降低整个组件的复杂度。</p>
</li>
<li><p>将 Effect 拆分出去，并通过参数传入。类似于这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">someEffect</span>(<span class="params">var1, var2</span>) &#123;</span><br><span class="line">  <span class="comment">// doSomething</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// useState...</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> <span class="title function_">someEffect</span>(var1, var2), [someVar])</span><br><span class="line">  <span class="comment">// return ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然这也是创建了一个函数，但是这个函数创建的速度和创建一个几十行几百行的逻辑的函数相比，确实快了不少。其次不建议使用 <code>.bind</code> 方法，他的执行效率并没有这种函数字面量快。</p>
<p>这种方式不建议手动来做，可以交给 babel 插件做这部分的优化工作。</p>
</li>
</ol>
<p>其实作为一个开发者来说，不应该太多的关注这部分，但是性能就是程序员的 XX 点，我还是会下意识从性能的角度来思考。这里只是提出了一点小小的优化方向，希望以后 React 官方也可以进一步做这部分的优化工作。</p>
<p>已经有的优化方案，可以查看官方 <a target="_blank" rel="noopener" href="https://reactjs.org/docs/hooks-faq.html#performance-optimizations">FAQ</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>经过这个简短的使用，感觉用了 Hook 你可以将更多的精力放在逻辑的编写上，而不是数据流的流动上。对于一些轻组件来说简直是再合适不过了，希望早点能够正式发布正式使用上吧。</p>
<p>另外 <code>parcel</code> 提供了强大的内置功能，让我们有着堪比 <code>webpack</code> 的灵活度却有着比 <code>webpack</code> 高效的开发速度。</p>
<p>好的，一篇 1 小时写代码，1 天写文章的水文写完了。以后如果有机会再深入尝试。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/12/26/react-hook-with-parcel-to-build-truth-or-dare/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/11/18/hindsight-fe-what-usage-of-position-sticky/">
                            【后知后觉系列】Css Position: Sticky 属性以及某些场景的使用
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Sun Nov 18 2018 00:00:00 GMT+0800">
	
		    11月 18, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/%E5%90%8E%E7%9F%A5%E5%90%8E%E8%A7%89/">后知后觉</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#position-sticky-%E8%BF%99%E7%A9%B6%E7%AB%9F%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BB%80%E4%B9%88%E9%AC%BC%EF%BC%9F"><span class="toc-text">position: sticky 这究竟是一个什么鬼？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF"><span class="toc-text">正确的使用姿势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E6%A0%97%E5%AD%90-%E9%80%9A%E8%AE%AF%E5%BD%95%E5%88%97%E8%A1%A8%E5%A4%B4%E9%83%A8"><span class="toc-text">举个栗子 - 通讯录列表头部</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E6%80%9D%E8%80%83"><span class="toc-text">拓展思考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%A3%80%E6%B5%8B%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E5%9B%BA%E5%AE%9A%EF%BC%9F"><span class="toc-text">如何检测是否已经被固定？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%A3%E8%83%BD%E4%B8%8D%E8%83%BD%E5%AE%9E%E7%8E%B0%E8%A1%A8%E6%A0%BC%E5%A4%B4-%E5%88%97%E5%9B%BA%E5%AE%9A%E5%91%A2%EF%BC%9F"><span class="toc-text">那能不能实现表格头&#x2F;列固定呢？</span></a></li></ol></li></ol>
<blockquote>
<p>不知何时，曾经我们认为的东西便会被打破，如果我们不坚持着去学习，那么我们终将会被社会所淘汰。于是我决定写《后知后觉系列》来记录一下我曾经跟不上的知识和关键点，内容不一定复杂，内容含量不一定高，也许别人已经写过一个一样的教程了，但是希望你能从我的笔记中获取你认为重要的东西，在纷繁复杂的工作中留下一个真正极客的世界，希望某一天这些东西都能够运用到工作当中。——XGHeaven</p>
</blockquote>
<blockquote>
<p>记得先看一下目录，找到你喜欢好奇的内容去针对性阅读，毕竟我不是来写教程的。</p>
</blockquote>
<h2 id="position-sticky-这究竟是一个什么鬼？"><a href="#position-sticky-这究竟是一个什么鬼？" class="headerlink" title="position: sticky 这究竟是一个什么鬼？"></a>position: sticky 这究竟是一个什么鬼？</h2><p>最近公司在用 Regular 封装一个表格组件，需要实现固定表头的功能。这个是几乎所有的组件库都会实现的一个效果，所以实现方式有很多种：</p>
<ol>
<li><p>因为 thead/tr 的 position 属性是无效的，所以需要单独用 div 创建一个表头。然后设置这个表头的 <code>position: absolute</code>，同时 <code>top: 0</code>。同时这种模式下，需要用户指定每一列的宽度，保证自制的表头和下面原生的表格一一对应起来。如果不指定的话，也可以等待 dom 渲染完成之后，再测量宽度。比如 Ant Design 就是使用的这种方式。</p>
</li>
<li><p>因为上面那种方案的难点在于无法很好的保证自制表头和原生表格宽度的一致性，所以我们组的大佬提出了使用原生 thead，监听 scroll 事件，设置 <code>transform</code> 属性使得表头进行偏移，从而实现 fixHeader 的问题，这种方式解决了第一个的问题，但是需要手动监听 scroll 事件，在快速滚动的情况下，可能会有一定的性能问题。而且不够优雅。如果后面的表格内容中有 <code>position: relative</code> 的元素，会覆盖到表头。</p>
</li>
</ol>
<p>不管是哪种方式，我总感觉不是很完美，于是我就在思考，除了手动更新的方式，难道就没有一些比较好的方式去做。然后我就去翻看了 github 的固定表头的方式，顿时豁然开朗。于是就延伸出了这篇文章，<code>position: sticky</code> 属性。</p>
<p><strong>Pay Attention</strong>：后面所讲的内容就不怎么和表格固定表头相关，如果你对表格固定表头或者固定列有一定问题，可以查看网易考拉的这篇文章 <a target="_blank" rel="noopener" href="https://blog.kaolafed.com/2017/12/25/%E4%B8%80%E8%B5%B7%E6%9D%A5%E8%81%8A%E8%81%8Atable%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9B%BA%E5%AE%9A%E5%88%97/">《一起来聊聊table组件的固定列》</a>。</p>
<p>当第一眼看到这个熟悉的时候，第一句话就是“我 CA”，这 TMD 是什么鬼属性，position 什么时候有了这个属性。于是去看了 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/position">MDN</a> 的介绍，可以理解为，这个属性是<strong>实现固定顶部最简单的实现方式</strong>。</p>
<p>他其实是一种 <code>position:relative</code> 和 <code>position: fixed</code> 的结合体，一定要配合 <code>top/right/bottom/left</code> 的属性一起才有作用，设置对应方向的最小值。当大于最小值的时候，他就像 <code>relative</code> 一样，作为文档流的一部分，并且 <code>top/right/bottom/left</code> 属性也会失效。否则当小于设置的值的时候表现的像 <code>fixed</code>，只不过这个 <code>fixed</code> 不再现对于窗口，而是相对于最近的可滚动块级元素。</p>
<p>如果你看过其他关于 sticky 的文章，大部分都会以黏贴的意思来解释他，那么很明显，确实也是这个意思，如果你觉得看了其他教程能够清楚的话，那么可以不用看我这篇了，如果你没看懂的话，可以来我这里看看。</p>
<p>废话少说，我们先来看一下如何正确使用 sticky。</p>
<h2 id="正确的使用姿势"><a href="#正确的使用姿势" class="headerlink" title="正确的使用姿势"></a>正确的使用姿势</h2><blockquote>
<p>以下的代码预览请使用最新 Chrome 查看，或者支持 position: sticky 的浏览器查看。部分网站不支持 iframe，可以去我的 Blog 查看</p>
</blockquote>
<ol>
<li><p><code>position: sticky</code> 只相对于第一个有滚动的父级块元素（scrolling mechanism，通过 overflow 设置为 <code>overflow/scroll/auto/overlay</code> 的元素），而不是父级块元素。</p>
<!-- unsupported embed -->
</li>
<li><p><code>position: sticky</code> 只有当设置对应的方向(top/right/bottom/left)，才会有作用，并且可以互相叠加，可以同时设置四个方向。</p>
</li>
<li><p>即使设置了 <code>position: sticky</code>，也只能显示在父级块元素的内容区域，他无法超出这个区域，除非你设置了负数的值。</p>
</li>
<li><p><code>position: sticky</code> 并不会触发 BFC，简单来讲就是计算高度的时候不会计算 float 元素。</p>
</li>
<li><p>当设置了 <code>position: sticky</code> 之后，内部的定位会相对于这个元素</p>
<!-- unsupported embed -->
</li>
<li><p>虽然 <code>position: sticky</code> 表现的像 <code>relative</code> 或者 <code>fixed</code>，所以也是可以通过 <code>z-index</code> 设置他们的层级。当这个元素的后面的兄弟节点会覆盖这个元素的时候，可以通过 <code>z-index</code> 调节层级。</p>
<p>See the Pen <a target="_blank" rel="noopener" href="https://codepen.io/xgheaven/pen/LXodKa/">position: sticky 通过 z-index 调节层级</a> by Bradley Xu (<a target="_blank" rel="noopener" href="https://codepen.io/xgheaven">@xgheaven</a>) on <a target="_blank" rel="noopener" href="https://codepen.io/">CodePen</a>.</p>
</li>
</ol>
<p>当你懂了这几个之后，其实这个属性就用起来就很简单了。</p>
<h2 id="举个栗子-通讯录列表头部"><a href="#举个栗子-通讯录列表头部" class="headerlink" title="举个栗子 - 通讯录列表头部"></a>举个栗子 - 通讯录列表头部</h2><p>no code no bb，直接上代码。</p>
<!-- unsupported embed -->
<h2 id="拓展思考"><a href="#拓展思考" class="headerlink" title="拓展思考"></a>拓展思考</h2><h3 id="如何检测是否已经被固定？"><a href="#如何检测是否已经被固定？" class="headerlink" title="如何检测是否已经被固定？"></a>如何检测是否已经被固定？</h3><p>最常见的需求就是，当还在文档流当中的时候，正常显示，但是当固定住的时候，添加一些阴影或者修改高度等操作。要想实现这个效果，第一反应可能就是手动监听 <code>scroll</code> 事件，判断位置，这当然是没有问题的，但是随之而来的确实性能的损耗。</p>
<p>最好的方式是使用 IntersectionObserver，这是一个可以监听一个元素是否显示在视窗之内的 API，具体内容见阮老师的<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/intersectionobserver_api.html">《IntersectionObserver API 使用教程》</a>。基本原理就是在一段滚动的头部和尾部分别添加两个岗哨，然后通过判断这两个岗哨的出现和消失的时机，来判断元素是否已经被固定。</p>
<p>例子<a target="_blank" rel="noopener" href="https://ebidel.github.io/demos/sticky-position-event.html">详见此处</a></p>
<h3 id="那能不能实现表格头-列固定呢？"><a href="#那能不能实现表格头-列固定呢？" class="headerlink" title="那能不能实现表格头/列固定呢？"></a>那能不能实现表格头/列固定呢？</h3><p>–理想很丰满，显示很骨感，因为 thead/tbody 对 position 无爱，所以也就不支持 sticky 属性，所以我们还是要单独创建一个头部。–</p>
<p>后来经过网友提醒，自己又去研究了一下，发现还是有办法做到固定表头和列的。</p>
<p>首先针对 Firefox，它本身就支持 thead/tbody 的 position 属性，所以可以直接通过对 thead/tbody 设置 position 来实现。而对于 Chrome 浏览器来讲，可以通过设置 thead 内的 th 来实现。具体见 Demo.</p>
<p>See the Pen <a target="_blank" rel="noopener" href="https://codepen.io/xgheaven/pen/RqmMQm/">position sticky 通过设置 td 来实现固定表头</a> by Bradley Xu (<a target="_blank" rel="noopener" href="https://codepen.io/xgheaven">@xgheaven</a>) on <a target="_blank" rel="noopener" href="https://codepen.io/">CodePen</a>.</p>
<p><strong>然后好像就没有了</strong>，谢谢观看水水的《后知后觉系列》</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/11/18/hindsight-fe-what-usage-of-position-sticky/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/10/14/the-trouble-of-installing-centos7/">
                            安装 CentOS7 中我所遇到的一些麻烦
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Sun Oct 14 2018 00:00:00 GMT+0800">
	
		    10月 14, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/VPS/">VPS</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Trouble-1-U-%E7%9B%98%E5%90%AF%E5%8A%A8%E6%89%BE%E4%B8%8D%E5%88%B0%E5%90%AF%E5%8A%A8%E7%9B%98"><span class="toc-text">Trouble 1: U 盘启动找不到启动盘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trouble-2-%E5%AE%89%E8%A3%85%E7%9A%84%E6%97%B6%E5%80%99%E6%98%8E%E6%98%8E%E6%8F%92%E7%9D%80%E7%BD%91%E7%BA%BF%E4%BD%86%E6%98%AF%E5%8D%B4%E6%8F%90%E7%A4%BA%E6%97%A0%E7%BD%91%E7%BB%9C"><span class="toc-text">Trouble 2: 安装的时候明明插着网线但是却提示无网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-1"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trouble-3-CentOS-%E5%AE%89%E8%A3%85%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E7%9B%B4%E5%8D%A1%E6%AD%BB%E5%9C%A8%E8%AE%BE%E7%BD%AE%E5%AE%89%E8%A3%85%E6%BA%90"><span class="toc-text">Trouble 3: CentOS 安装的时候一直卡死在设置安装源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-2"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%AE%8C%E6%AF%95"><span class="toc-text">安装完毕</span></a></li></ol>
<blockquote>
<p>自己家里有一台 Dell 服务器，之前一直跑着 FreeNAS，后来发现自己对 NAS 的需求并不是很高，所以我决定装回 Linux，之前用的 Debian，虽然 Debian 很好，但是没法只使用 root 用户，所以我又回归了 CentOS 系统，但是问题并没有我想的那么简单。</p>
</blockquote>
<p>另外，这是一篇总结文章，所以<code>没有图</code>，见谅。</p>
<h2 id="Trouble-1-U-盘启动找不到启动盘"><a href="#Trouble-1-U-盘启动找不到启动盘" class="headerlink" title="Trouble 1: U 盘启动找不到启动盘"></a>Trouble 1: U 盘启动找不到启动盘</h2><p>这里所说的找不到启动盘并不是说无法进入引导界面，而是说进入了引导界面但是无法正确加载安装镜像。具体表现请往下看</p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>相信大家装过系统的都知道，在 Windows 上面有很多 ISO 刻录到 U 盘的工具，这些工具非常好用，所以我就理所当然的用 <code>ISO to USB</code> 这个软件刻录启动 U 盘。</p>
<p>我刻录的是 <code>CentOS-7-DVD</code> 的版本，大约 4.2G，里面包含了必要的安装包。</p>
<p>U 盘刻录完成，插入电脑，启动，一切正常，进入选择界面，选择 <code>Install CentOS 7</code>，之后问题来了，出现了 <code>failed to map image memory</code> 提示，之后等了一段时间之后就一直出现 <code>warning:dracut-initqueue timeout-starting timeout script</code> 的提示，最终显示启动失败，进入恢复模式，显示 <code>dracut:/#</code> 终端提示符，不管怎么重启都不行。</p>
<p>当然，Google 当然是有结果的，<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42609121/article/details/81737671">《安装CentOS7.4出现failed to map image memory以及warning:dracut-initqueue timeout的解决办法》</a> 指出了原因和解决方案。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>出现这个原因是因为找不到启动盘，解决方案其实也很简单，就是手动设置一下就可以了。</p>
<p>首先找到你的 U 盘是哪个硬盘符，方法就是在恢复模式下运行 <code>ls -l /dev | grep sd</code>，可以看到一系列的文件，一般情况下 sda 是硬盘，sdb 是 U 盘，sda1 是硬盘上第一个分区，同理 sda2 是第二个分区。如果你有多个硬盘，那么 U 盘可能是 sdc, sdd 等等，找到你的 U 盘启动盘的分区，我的是 sdb1。</p>
<p>然后在选择界面的时候按 e，然后将 <code>inst.stage2=hd:LABEL=CentOS\x207\x20x86_64.check</code> 修改为 <code>inst.stage2=hd:/dev/sdbx(你u盘所在)</code>，之后修改结束之后按 <code>Ctrl+x</code> 退出就可以正常进入安装界面了。</p>
<p>那么有人会说每次启动都要这么做么？答案是的，但实在是太麻烦了，不急，这个也是有办法解决的，办法请看 Trouble 3 的解决方案。</p>
<h2 id="Trouble-2-安装的时候明明插着网线但是却提示无网络"><a href="#Trouble-2-安装的时候明明插着网线但是却提示无网络" class="headerlink" title="Trouble 2: 安装的时候明明插着网线但是却提示无网络"></a>Trouble 2: 安装的时候明明插着网线但是却提示无网络</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>进入安装界面之后，会有一个网络的选项，一直提示未连接，不管你怎么设置。无论是你拔插网线还是禁用启用都不行。</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>这是因为 CentOS 默认的网络是不自动连接的，你可以在设置界面，选择 General ，也就是第一个标签页，把启动时自动连接网络的选项勾选，然后保存。然后就会自动去获取 ip 地址然后可以上网了。</p>
<p>这一点的设计实在是太 SB 了，不知道为啥要设计成这个样子。</p>
<h2 id="Trouble-3-CentOS-安装的时候一直卡死在设置安装源"><a href="#Trouble-3-CentOS-安装的时候一直卡死在设置安装源" class="headerlink" title="Trouble 3: CentOS 安装的时候一直卡死在设置安装源"></a>Trouble 3: CentOS 安装的时候一直卡死在设置安装源</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>当我们成功进入安装界面的时候，你会发现他的安装源是无效的，需要你自己去设置。 理论上来讲使用的是 DVD 的镜像，是自带了很多包的，不会出现这种情况。 而且出现这种情况的时候，是无法选择本地的安装源的，只能填写网络。 但是不管你填写的是官方的安装源还是阿里、网易的安装源，都会一直卡死在设置安装源这个环节。</p>
<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>经过 Google，得知原因是因为刻录 U 盘的方式不对。<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_757fc71d0102w7bb.html">《CentOS7安装时的新问题》</a> 给出了原因和解决方案。</p>
<p>引用之</p>
<blockquote>
<p>绝望中，无意间看到 Centos 百科(<a target="_blank" rel="noopener" href="https://wiki.centos.org/zh/HowTos/InstallFromUSBkey">https://wiki.centos.org/zh/HowTos/InstallFromUSBkey</a>) 上的一段话：“由于 CentOS 7 安装程序的映像采用了特殊的分区，而截至 2014 年 7 月，大部份Windows 工具都不能正确地转移，因此利用 USB 存储器开机时会导致不能预知的结果。（暂时）已知不适用的工具包括 unetbootin 和 universal usb installler。已确定能正确运作的有 Rufus、Fedora LiveUSB Creator、Win32 Disk Imager、Rawrite32 及 dd for Windows。如果采用 Windows 7 以上的版本，请先卸下该 USB 存储器（其中一个方法是在执行工具程序前把存储器格式化），否则 indows 可能会拒绝写入该存储器，出现 can’t write to drive 错误及取消行动。”</p>
</blockquote>
<p>可以得知，CentOS 的 ISO 镜像的刻录方式比较特殊，大部分软件都无法很好的兼容，但是 dd 可以非常好的兼容，所以这里我切换了刻录软件，使用 <code>Rufus</code> 进行刻录，并且选择 DD 模式。</p>
<p>然后重启启动，哈哈哈，不仅仅这个问题解决了，还完美解决了 Trouble 1 无法找到启动盘的问题。</p>
<h2 id="安装完毕"><a href="#安装完毕" class="headerlink" title="安装完毕"></a>安装完毕</h2><p>记得之前安装的时候，也没有遇到这么多麻烦。这次既然遇到了就记录下来。</p>
<p>之后我就可以开心的玩耍了，装了 Docker，切换安装源到网易，安装 epel 等等。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/10/14/the-trouble-of-installing-centos7/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/05/03/npm-to-yarn-to-npm/">
                            为什么我从 Npm 到 Yarn 再到 Npm?
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Thu May 03 2018 00:00:00 GMT+0800">
	
		    5月 03, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Node-js/">Node.js</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-npm"><span class="toc-text">放弃 npm?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E5%8F%A4%E6%97%B6%E4%BB%A3"><span class="toc-text">上古时代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E9%93%BE%E6%97%B6%E4%BB%A3"><span class="toc-text">软链时代</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm3-%E6%97%B6%E4%BB%A3"><span class="toc-text">npm3 时代</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yarn-%E7%9A%84%E8%AF%9E%E7%94%9F"><span class="toc-text">yarn 的诞生</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E6%8B%BE-npm-5"><span class="toc-text">重拾 npm 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
<blockquote>
<p>从接触到 node 环境来说，其中一个不可或缺的一部分便是 npm 包管理，但是由于官方的 npm 有各种各样的问题，于是催生了很多不同的版本，这其中的曲折也许只有过来人才知道。</p>
</blockquote>
<h2 id="放弃-npm"><a href="#放弃-npm" class="headerlink" title="放弃 npm?"></a>放弃 npm?</h2><h3 id="上古时代"><a href="#上古时代" class="headerlink" title="上古时代"></a>上古时代</h3><p>在上古版本(应该是 npm3 以前的版本，具体我也记不清了)，npm 的安装策略并不是扁平化的，也就是说比如你安装一个 <code>express</code>，那么你会在 <code>node_modules</code> 下面只找到一个 <code>express</code> 的文件夹。而 <code>express</code> 依赖的项目都放在其文件夹下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- app/</span><br><span class="line">  - package.json</span><br><span class="line">  - node_modules/</span><br><span class="line">    - express/</span><br><span class="line">      - index.js</span><br><span class="line">      - package.json</span><br><span class="line">      - node_modules/</span><br><span class="line">        - ...</span><br></pre></td></tr></table></figure>
<p>这个带来的问题或许 windows 用户深谙其痛，因为在这种安装环境下，会导致目录的层级特别高，而对于 windows 来说，最大的路径长度限制在 248 个字符(<a target="_blank" rel="noopener" href="https://www.cnblogs.com/52cik/p/node-modules-del.html">更多请见此</a>)，再加上 <code>node_modules</code> 这个单词又特别长，所以你懂得，哈哈哈。解决方案啥的自己去搜索吧，反正估计现在也没人会用上古版本了。</p>
<p>除了 windows 用户出现的问题以外，还有一个更严重的问题，就是模块都是独立的，比如说位于 <code>express</code> 下面的 <code>path-to-regexp</code> 和 <code>connect</code> 下面的 <code>path-to-regexp</code> 的模块是两个不同的模块。 那么这个会带来什么影响呢？其实在使用上，并没有什么太大的影响，但是内存占用过大。因为很多相同模块位于不同模块下面就会导致有多个实例的出现(为什么会加载多个实例，请查看 <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js">Node 模块加载</a>)。你想想，都是同样的功能，为什么要实例这么多次呢？不能就加载一次，复用实例么？</p>
<p>上古时代的 npm 的缺点可以说还是很多的：</p>
<ul>
<li><p>目录嵌套层级过深</p>
</li>
<li><p>模块实例无法共享</p>
</li>
<li><p>安装速度很慢，这其中有目录嵌套的原因，也有安装逻辑的问题。因为 npm 是请求完一个模块之后再去请求另一个模块，这就会导致同一个时刻，只有一个模块在下载、解析、安装。</p>
</li>
</ul>
<h3 id="软链时代"><a href="#软链时代" class="headerlink" title="软链时代"></a>软链时代</h3><p>后面，有人为了解决目录嵌套层次过高的问题，引入的软链接的方案。</p>
<p>简单来说，就是将所有的包都扁平化安装到一个位置，然后通过软链接(windows 快捷方式)的方式组合到 <code>node_modules</code> 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- app/</span><br><span class="line">- node_modules</span><br><span class="line">  - .modules/</span><br><span class="line">    - express@x.x.x/</span><br><span class="line">      - node_modules</span><br><span class="line">        - connect -&gt; ../../connect@x.x.x</span><br><span class="line">        - path-to-regexp -&gt; ../../path-to-regexp@x.x.x</span><br><span class="line">        - ... -&gt; ../../package-name@x.x.x</span><br><span class="line">    - connect@x.x.x/</span><br><span class="line">    - path-to-regexp@x.x.x/</span><br><span class="line">    - ...others</span><br><span class="line">  - express -&gt; ./.modules/express@x.x.x</span><br></pre></td></tr></table></figure>
<p>这样做的好处就是可以将整体的逻辑层级简化到很少的几层。而且对于 node 的模块解析来说，可以很好的解决相同模块不同位置导致的加载多个实例，进而导致内存占用的情况。</p>
<p>基于这种方案，有 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/npminstall">npminstall</a> 以及 pnpm 这个包实现了这种方案，其中 cnpm 使用的就是 npminstall，不过他们实现的方式和我上面讲的是有差异的，<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/npminstall#node_modules-directory">具体请看</a>。简单来讲，他们没有 <code>.modules</code> 这一层。更多的内容，请看 npminstall 的 README。</p>
<p>总的来讲这种解决方案有还有以下几个好处：</p>
<ul>
<li><p>兼容性很好</p>
</li>
<li><p>在保证目录足够简洁的情况下，解决了上面的两个问题（目录嵌套和多实例加载）。</p>
</li>
<li><p>安装速度很快，因为采用了软连接的方式加上多线程请求，多个模块同时下载、解析、安装。</p>
</li>
</ul>
<p>那么缺点也是挺致命的：</p>
<ul>
<li><p>一般情况下都是第三方库实现这个功能，所以无法保证和 npm 完全一致的行为，所以遇到问题只能去找作者提交一下，然后等待修复。</p>
</li>
<li><p>无法和 npm 很方便的一起使用。最好是要么只用 npm，要么只用 cnpm/pnpm，两者混用可能会产生很奇葩的效果。</p>
</li>
</ul>
<h2 id="npm3-时代"><a href="#npm3-时代" class="headerlink" title="npm3 时代"></a>npm3 时代</h2><p>最大的改变就是将目录层级从嵌套变到扁平化，可以说很好的解决了上面嵌套层级过深以及实例不共享的问题。但是，npm3 在扁平化方案下，选择的并不是软连接的方式，而是说直接将所有模块都安装到 <code>node_modules</code> 下面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- app/</span><br><span class="line">- node_modules/</span><br><span class="line">  - express/</span><br><span class="line">  - connect/</span><br><span class="line">  - path-to-regexp/</span><br><span class="line">  - ...</span><br></pre></td></tr></table></figure>
<p>如果出现了不同版本的依赖，比如说 <code>package-a</code> 依赖 <a href="mailto:`package-c@0.x.x">`package-c@0.x.x</a><code>的版本，而</code>package-b<code>依赖</code><a href="mailto:package-c@1.x.x">package-c@1.x.x</a>` 版本，那么解决方案还是像之前的那种嵌套模式一样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- app/</span><br><span class="line">- node_modules/</span><br><span class="line">  - package-a/</span><br><span class="line">  - package-c/</span><br><span class="line">    - // 0.x.x</span><br><span class="line">  - package-b/</span><br><span class="line">    - node_modules/</span><br><span class="line">      - package-c/</span><br><span class="line">        - // 1.x.x</span><br></pre></td></tr></table></figure>
<p>至于那个版本在外面，那个版本在里面，似乎是根据安装的先后顺序有关的，具体的我就不验证了。如果有人知道的话，欢迎告诉我。</p>
<p>在这个版本之后，解决了大部分问题，可以说 npm 跨入了一个新的世界。但是还要一个问题就是，他的安装速度依旧很慢，相比 cnpm 来说。所以他还有很多进步的空间。</p>
<h2 id="yarn-的诞生"><a href="#yarn-的诞生" class="headerlink" title="yarn 的诞生"></a>yarn 的诞生</h2><p>随着 Node 社区的越来越大，也有越来越多的人将 Node 应用到企业级项目。这也让 npm 暴露出很多问题：</p>
<ul>
<li><p>无法保证两次安装的版本是完全相同的。大家都知道 npm 通过语义化的版本号安装应用，你可以限制你安装模块的版本号，但是你无法限制你安装模块依赖的模块的版本号。即使有 shrinkwrap 的存在，但是很少有人会用。</p>
</li>
<li><p>安装速度慢。上文已经讲过，在一些大的项目当中，可能依赖了上千个包，甚至还包括了 C++ Addon，严重的话，安装可能要耗时 10 分钟甚至到达半个小时。这很明显是无法忍受的，尤其是配合上 CI/CD。</p>
</li>
<li><p>默认情况下，npm 是不支持离线模式的，但是在有些情况下，公司的网络可能不支持连接外网，这个时候利用缓存构建应用就是很方便的一件事情。而且可以大大减少网络请求。</p>
</li>
</ul>
<p>所以，此时 yarn 诞生了，为的就是解决上面几个问题。</p>
<ul>
<li><p>引入 yarn.lock 文件来管理依赖版本问题，保证每次安装都是一致的。</p>
</li>
<li><p>缓存加并行下载保证了安装速度</p>
</li>
</ul>
<p>那个时候我还在使用 cnpm，我特地比较了一下，发现还是 cnpm 比较快，于是我还是继续使用着 cnpm，因为对于我来说足够了。但是后面发现 yarn 真的越来越火，再加上 cnpm 长久不更新。我也尝试着去了用 yarn，在尝试之后，我彻底放弃了 cnpm。而且直到现在，似乎还没有加入 lock 的功能。</p>
<p>当然 yarn 还不只只有这么几个好处，在用户使用方面：</p>
<ul>
<li><p>提供了非常简洁的命令，将相关的命令进行分组，比如说 <code>yarn global</code> 下面都是与全局模块相关的命令。而且提示非常完全，一眼就能看明白是什么意思。不会像 npm 一样，<code>npm --help</code> 就是一坨字符串，还不讲解一下是什么用处，看着头疼。</p>
</li>
<li><p>默认情况安装会保存到 dependencies，不需要像 npm 一样手动添加 <code>S</code> 参数</p>
</li>
<li><p>非常方便的 yarn run 命令，不仅仅会自动查看 package.json 中 scripts 下面的内容，还是查找 <code>node_modules/.bin</code> 下的可执行文件。这个是我用 yarn 最高的频率。比如你安装了 <code>yarn add mocha</code>，然后就可以通过 <code>yarn run mocha</code> 直接运行 <code>mocha</code>。而不需要 <code>./node_modules/.bin/mocha</code> 运行。是我最喜欢的一个功能</p>
</li>
<li><p>交互式的版本依赖更新。npm 你只能先通过 <code>npm outdated</code> 看看那些包需要更新，然后通过 <code>npm update [packages]</code> 更新指定的包。而在 yarn 当中，可以通过交互式的方式，来选择那些需要更新，那些不需要。</p>
</li>
<li><p>全局模块的管理。npm 管理全局模块的方式是通过直接在 <code>/usr/lib/node_modules</code> 下面安装，然后通过软连接连接到 <code>/usr/local/bin</code> 目录下。而 yarn 的做法是选择一个目录，这个目录就是全局模块安装的地方，然后将所有的全局模块当做一个项目，从而进行管理。这个好处就是，你可以直接备份这个目录当中的 package.json 和 yarn.lock 文件，从而可以很方便的在另一个地方还原你安装了那些全局模块。至于这个目录的问题，通过 <code>yarn global dir</code> 命令就可以找到，mac 下是在 <code>~/.config/yarn/global/</code>，linux 我没有测试过。</p>
</li>
</ul>
<p>可以说 yarn 用起来非常舒服，但是唯一的缺点就是不是 npm 官方出的，更新力度、兼容性都会差一些。但这也阻挡不住 yarn 在 Node 社区的火热程度。很快，大家纷纷从 npm 切换到 yarn 上面。</p>
<h2 id="重拾-npm-5"><a href="#重拾-npm-5" class="headerlink" title="重拾 npm 5"></a>重拾 npm 5</h2><p>在受到 yarn 的冲击之后，npm 官方也决定改进这几个缺点，于是发布了和 Yarn 对抗(这个词是我意淫的)的 npm5 版本。</p>
<ol>
<li><p>引入了 package-lock.json，并且默认就会添加，和 yarn.lock 是一样的作用，并且取代之前的 npm shrinkwrap。</p>
</li>
<li><p>默认情况下，安装会自动添加 dependencies，不需要手动书写 <code>S</code> 参数</p>
</li>
<li><p>提升了安装速度，和之前有了很大的进步，但是和 yarn 相比，还是略微慢一些</p>
</li>
</ol>
<p>至此，yarn 和 npm 的差距已经非常非常小了，更多的差距体现在用户体验层面，我使用 yarn 的功能也只剩下全局模块管理、模块交互式更新和 <code>yarn run</code> 这个命令了。</p>
<p>但是后面推出的 npx 让我放弃了使用 <code>yarn run</code> 这个命令。不是说 npx 比 yarn 有多好，而是说 npm 集成了这个功能，也就没必要再去使用第三方的工具了。而且 npx 还支持临时安装模块，也就是那种只用一次的命令，用完就删掉了。</p>
<p>后面我又发现了 <code>npm-check</code> 这个工具，我用它来替代了 yarn 的交互式更新。</p>
<p>然而 npm6 的出现加入了缓存，并且又进一步提升了速度，可以说直逼 yarn。</p>
<p>于是 yarn 对我来说只剩下一个全局模块管理的功能了。我的整个开发流程以及从 yarn 切换回 npm 上面了。或许后面的日子我也会让 npm 来接管全局模块管理，从而放弃使用 yarn。但是我还是会装 yarn，毕竟有一些老项目还是用 yarn 的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我经历了从 npm -&gt; cnpm -&gt; yarn -&gt; (npm + npm-check + npx) 的一个循环，也见证了 npm 社区的一步步发展。而且 yarn 的更新频率也非常慢，可能一个月才更新一次，这也让我逐渐放弃使用 yarn。</p>
<p>有的时候感觉，第三方的终究是第三方，还是没有原生的好用和方便，而且用起来安心。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/05/03/npm-to-yarn-to-npm/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/04/16/nest-js-try-first/">
                            Nest.js 入手以及企业化的思考
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Mon Apr 16 2018 00:00:00 GMT+0800">
	
		    4月 16, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Node-js/">Node.js</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E7%AE%80%E4%BB%8B"><span class="toc-text">框架简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest-js-%E4%BC%81%E4%B8%9A%E5%8C%96%E5%BD%93%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">Nest.js 企业化当中的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest-js-%E4%BC%81%E4%B8%9A%E5%8C%96%E7%9A%84%E5%B0%9D%E8%AF%95"><span class="toc-text">Nest.js 企业化的尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-text">配置管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="toc-text">进程管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iron-js"><span class="toc-text">Iron.js</span></a></li></ol>
<blockquote>
<p>本人是一名 Node.js 实习生，在进入大搜车之后，有幸见识到 Akyuu.js 这个框架。但是这个框架是使用 Express + Callback 的方式，我不是很喜欢。在我的推荐以及社区的发展下，组长决定用 TS + Async/Await 来试一试。于是我也去了解了一下 TS 的后端框架有哪些，结果经过别人推荐，找到了 Nest.js 这个想法几乎和我一模一样的框架。</p>
</blockquote>
<h2 id="框架简介"><a href="#框架简介" class="headerlink" title="框架简介"></a>框架简介</h2><p>因为我这个不是教程向，所以就不细讲，可以查看 <a target="_blank" rel="noopener" href="https://nestjs.com/">Nest.js</a> 官网。从我的感性角度来讲，简单说一下以下几个特点：</p>
<ul>
<li><p>去中心化路由。所有的路由通过装饰器与 Controller 绑定。简单、明了，学习成本低。</p>
</li>
<li><p>TypeScript/Rx.js 加持。智能补全，代码分析，静态类型等等优点。如果你只是个人用用的话，可能会觉得很全。但是放在企业当中使用，是非常大的优点。</p>
</li>
<li><p>依赖注入。从 Angular 那里学习而来，但是进行了一些简化，但是完全够用。比如说简化掉了 deps。</p>
</li>
<li><p>模块思想。Node 社区的后端框架，其实都被 Express 导向到了中间件的模式。而 Nest.js 却从 Angular 当中吸取到了模块的思想。不同的 Service、Controller、Component 组成不同的模块。模块之间可以相互依赖，也可以独立存在，这大大减少了测试和逻辑的复杂度。</p>
</li>
<li><p>易于扩展。以往的框架，你能做的就是编写业务逻辑，而其他的你都很难去做到。于是传统的后端框架不得不引入了一套插件机制来增强框架的扩展性。但是 Nest.js 将插件的功能直接内置到了框架当中。传统的插件在这里可以认为就是一个模块，通过加载不同的模块来添加不同的功能。</p>
</li>
<li><p>Express 基石。有人会说，不是现在 Koa 才是更好的模型么？洋葱模型可以解决更多复杂的问题。没错，我不反对这个言论。但是我想说的是，Express 还是最简单最通用的方式，因为他不赖 Generator/Promise，只需要你又一个 Node.js 运行环境，支持 Callback 就可以了。（话说应该没有不支持 Callback 的 Node.js 环境吧，哈哈哈）不管怎么样，Express 的覆盖面还是比 Koa 要广不少。</p>
</li>
<li><p>条条大路通罗马。那么有人就问了，那我要实现洋葱模型怎么办呢？我想说，办法总是会有的。而在 Nest.js 当中，通过 Interceptor ，可以很好的实现洋葱模型。也就是说你可以通过 Interceptor 来记录请求的耗时。</p>
</li>
<li><p>同步代码。这里所说的同步代码并不是单单指的是 async/await。在很多支持 async/await 的框架中，如果你想返回值，如果是 Express ，你还是需要调用 <code>resp.send(await getValue())</code>，而 koa 也是需要调用 <code>ctx.body = await getValue()</code>。但是在 Nest.js 中，只需要 <code>return await getValue()</code> 即可。实现真正的同步编写业务逻辑代码。</p>
</li>
<li><p>逻辑分层。其实很多功能，都是可以通过中间件来实现的。但是不同类型的功能有不同的需求，如果只是通过中间件来实现，势必会导致有一些重复的代码。于是 Nest.js 里面引入了 Pipe/Interceptor/Guard/ExceptionFilter 等逻辑层。不同的层里面处理相似的事情，比如说 Pipe 处理的是输入数据的转换。而 Interceptor 来实现洋葱模型。Guard 用于权限校验等拦截任务。ExceptionFilter 用来处理错误数据。这种分层带来的好处就是可以让代码更加清晰，主需要思考这个层需要做的事情，而不需要站在中间件的层面去考虑这个事情。</p>
</li>
<li><p>Validation。自带校验，而且和 TS 结合的非常完美，使用起来很舒服，请看<a target="_blank" rel="noopener" href="https://docs.nestjs.com/pipes">教程</a></p>
</li>
<li><p>输入参数的转换。这个其实是一个很方便的方面。有的时候你需要将输入的参数转换成一个类，这个时候你就可以通过 Validation 进行转换。你要是不想用自动转换，可以通过传统的手动转换的方式。</p>
</li>
<li><p>测试功能完美。由于采用了依赖注入，所以测试简直简单的不得了。而且官方也提供了一系列测试工具，也能很好的解决单元测试的问题。</p>
</li>
</ul>
<h2 id="Nest-js-企业化当中的问题"><a href="#Nest-js-企业化当中的问题" class="headerlink" title="Nest.js 企业化当中的问题"></a>Nest.js 企业化当中的问题</h2><ul>
<li><p>目录无约束。在企业当中，不对目录进行约束会导致代码越来越乱。从而降低了代码可维护性。</p>
</li>
<li><p>没有配置管理功能。在框架开发中，配置往往是一个很重要的功能。比如说配置数据库的连接，配置监听的端口。</p>
</li>
<li><p>没有进程管理。虽然有提供 <code>@nestjs/cli</code>，但是这个提供的仅仅是一个项目的创建的能力。</p>
</li>
<li><p>部分文档讲解不详细，会提高入门的门槛。</p>
</li>
</ul>
<p>不过总的来说，前面几点也正是 Nest.js 灵活性的保证。但是我们真正在开发当中，还是需要一种合理的约束来保证开发的统一。</p>
<h2 id="Nest-js-企业化的尝试"><a href="#Nest-js-企业化的尝试" class="headerlink" title="Nest.js 企业化的尝试"></a>Nest.js 企业化的尝试</h2><p>那么我们这里针对上面的几个问题，尝试采用一些方式来进行约束。</p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>我们对项目指定如下的规则：</p>
<ul>
<li><p>全部通过 TypeScript 书写，并且全部位于 <code>src</code> 目录下</p>
</li>
<li><p>入口文件是 <code>main.ts</code> 如果没有特殊情况，不动这个文件</p>
</li>
<li><p>配置放在 <code>src/config</code> 文件夹下</p>
</li>
<li><p>所有的 Service/Controller/Logic/Component 等都挂载到 <code>MainModule</code> 下。</p>
</li>
<li><p>其中 <code>module</code> 文件夹存放自定义的 Module，或者说希望独立成模块但是还没有完全独立出来的。其中目录结构和这个项目目录结构类似</p>
</li>
<li><p><code>boot</code> 文件夹是项目启动代码的时候执行的，这部分在 Nest.js 当中没有给出。我这里打算添加这个功能，但是还没有想好具体的实现形式，所以待定。</p>
</li>
<li><p><code>interface</code>/<code>enum</code> 等数据随着对应的 service 导出。不另做说明。比如说 <code>car.service.ts</code> 除了可以导出 <code>CarService</code> 类以外，还可以导出 <code>CarType</code> enum。</p>
</li>
<li><p><code>dest</code> 文件夹是编译之后的文件，可以直接输入 <code>node dest/main.js</code> 运行。</p>
</li>
<li><p>命名规则</p>
<ul>
<li><p>所有的文件除了 main.ts 和类文件以外，都要添加类型后缀，比如说 <code>user.model.ts</code> <code>car.controller.ts</code> <code>google.logic.ts</code>。但是比如说只是一个 <code>Car</code> 类，那么可以直接命名成 <code>car.ts</code></p>
</li>
<li><p>不允许通过 <code>export default</code> 导出数据。一方面是为了方便导入的时候保证命名的统一，另一方面可以随时导出 interface/enum 等内容。</p>
</li>
<li><p>所有的测试文件后缀名都以 <code>.spec.ts</code> 或 <code>.test.ts</code> 结尾。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">|-- dest</span><br><span class="line">    |--- ...</span><br><span class="line">|-- src</span><br><span class="line">    |-- config</span><br><span class="line">    |-- controller</span><br><span class="line">    |-- model</span><br><span class="line">    |-- service</span><br><span class="line">    |-- logic</span><br><span class="line">    |-- component</span><br><span class="line">    |-- boot</span><br><span class="line">    |-- module</span><br><span class="line">        |-- module-name</span><br><span class="line">            |-- config</span><br><span class="line">            |-- index.ts</span><br><span class="line">            |-- module-name.module.ts</span><br><span class="line">    |-- main.ts</span><br><span class="line">    |-- main.module.ts</span><br></pre></td></tr></table></figure>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>我目前初步的想法是通过提供一个 <code>ConfigModule</code> 暴露出一个 <code>ConfigService</code> 来提供配置的获取和查看。</p>
<p>在某些情况下，可能需要多级配置，模块级别的配置，应用级别的配置。那么 <code>ConfigService</code> 可以在获取配置的时候自动合并这些规则。</p>
<h3 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h3><p>现在已经是 18 年了，不用 Docker 你真的对得起自己么？很明显是对不起的。所以进程管理这一块，我们就交给 Docker 来处理。包括启动、停止、重启、日志等，都交给 Docker。</p>
<p>于是启动命令就可以简化成 <code>node dest/main.js</code> 即可。</p>
<p>那么你可能会想到，如果一个 Docker 环境给你分配了两个 u，那岂不是会浪费一个 u。理论上是的，那么你就可以通过 pm2 啊啥的自己去管理吧，哈哈哈，不管。</p>
<h2 id="Iron-js"><a href="#Iron-js" class="headerlink" title="Iron.js"></a>Iron.js</h2><p>说了这么多，把上面的内容都沉淀下来，我得要给他取个名字，于是我就取成了 Iron。为啥叫 Iron 呢？因为 Iron Man。那为啥因为 Iron Man 呢？因为他制作的盔甲可以自由拆分，自动拼合。非常适合我们这个项目的形态。</p>
<p>不过这个项目什么时候能沉淀下来，看我心情了。不过定个时间线吧，就在 4 月底，争取搞定。</p>
<p>因为这里面最大的问题就是配置的问题，需要深入依赖注入，所以会麻烦一些。但是其他的方面更多的只是一种约束吧。</p>
<p>这就是我用 Nest.js 一周以来的心得。暂时就想到这么多，更多的内容等我后面再分析吧。</p>
<p>写完睡觉，答应女票了，啦啦啦~</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/04/16/nest-js-try-first/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/02/16/summary-2018/">
                            2018 年终总结
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Fri Feb 16 2018 00:00:00 GMT+0800">
	
		    2月 16, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">年终总结</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E4%B9%A0"><span class="toc-text">实习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E5%AD%A6"><span class="toc-text">大学</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2018-%E5%B1%95%E6%9C%9B"><span class="toc-text">2018 展望</span></a></li></ol>
<p>2017 年，有开心，也有失落。也不知道该从何说起，就随便写写了。高中语文就没学好过，所以可能写成流水账了。请各位看官多多包涵。</p>
<h1 id="实习"><a href="#实习" class="headerlink" title="实习"></a>实习</h1><p>如今步入大四，最大的心事就是找实习找 Offer 了。先后经历了两次阿里面试的失利，至于失利的过程，我之前有吐槽过，就不多说了，而且听说今年的面试难度提升到了社招，心痛。饿了么/七牛都有投递过，但是都没有进。如果各位看官想招 Node.js 或者 前端 的校招生的话，请联系我哦~ <code>请在各大社交媒体请搜索 XGHeaven 即可</code></p>
<p>终于在 CNode 上面找到了一家美国 AR 公司，Integem。</p>
<p>在里面主要是用 Electron 做客户端，技术栈就是 Vue 全家桶，不多说了。反正整体干下来的感觉其实和自己接了一个外包的感觉差不多，而且设计师设计的页面参差不齐。最可气的是，假设页面 A 和页面 B 相同的部分，没准一个就有边框，另一个就没有。没准一个字体是 12px，另一个可能就是 16px。真是受不了，一开始，我还是让他确认一下到底哪个设计图是对的，到最后，只能用我的佛系心态对待这个设计图，懒得问了。切个图，也是切的乱七八糟，我还是自己来好了。</p>
<p>在里面差不多干了 5 个月，再加上学校要求每个人都要去跟着导师完成一个实践项目，于是我就离开了。</p>
<p>再之后，我在逛实习的时候，突然发现大搜车在招 Node.js 实习生，而且标注的是有大牛带。大搜车……为啥听着这么耳熟啊，不管了，报了再说。于是我就去面试了。面试我的是一个胖胖的留着胡子的人（死月罪过，当时并不知道那是你），于是和他相聊甚欢，最后还记得，当时看到他的 15寸 macbook pro 后面贴着一个 bad apple 的一个贴纸。当时顺口就问了一句，这个是 bad apple 么？当时之所以会问这个，因为我还记得很早以前，看过一个人的博客，里面讲到了他在花瓣网工作，而且很详细的讲解了图片主题色的提取和 Node.js NAN API，感觉受益匪浅，于是我当时在想，这是哪个学校的大牛，竟然这么厉害。后来看到他已经在花瓣工作了。。。不过我记得他很喜欢二次元。。。于是面试的时候，我在想会不会是他，于是就问了句贴纸，以为他会聊起二次元，结果他随便应了一句就过去了。我见状就没再继续问下去了。后面安慰道自己说，没事，那个人应该不会在大搜车。面试我这个人感觉还是很厉害的~~至少有一点，我说我提过 issue 给 node，他能马上就打开 github 看。这一点让我很敬佩，因为大部分面试都是会听你描述，看简历上面写的，而不是当场去查看。举个例子，你跟面试官说你博客写了很多高品质的文章，大部分面试官会直接问你有什么，他不会自己去看。而好的面试官会一边问你，一边自己打开看。。。我是这么觉得的。反正不管当时是不是月老，我已经决定来这家公司了。</p>
<p>哈哈哈，后面等进大搜车之后，剧情反转。那个人其实就是死月。当时看到他在 QQ 群里面的时候，你知道我的心里有多么开心么！！但是，有一个噩耗，就是他在我去的前几周已经跳槽去蚂蚁金服了，哭 (((T____T))) 我的大牛啊，你怎么走了啊啊啊啊</p>
<p>不过还好，也认识了挺多大牛的，不过还是没见到过我心仪的 朴灵/不四/狼叔 -_-。</p>
<p>现在在大搜车呆了有两个月了吧，那就简单总结一下干了啥吧：</p>
<ul>
<li><p>完成了一个图片上传服务，里面包含了公共的图片上传，以及大风车的头像上传，真正的编码时间也就两个星期，但是真的发布上去，却花了一个月。</p>
</li>
<li><p>现在准备一个请求限制框架，讲道理这是很简单的一个工作，但是我看时间很充裕，于是我就想写大，看看能不能独立成一个库，开源骗 star。</p>
</li>
<li><p>期间还要各种小东西，修修补补。</p>
</li>
</ul>
<p>刚进大搜车，按理来说，带我的人应该是小山，但是那个时候他请了几天假，于是就鹏飞暂时带着我。让我看了 Akyuu.js 和帕秋莉网关。之后其实所有的时间都是跟着鹏飞，我师父小山感觉不喜欢多说话，平时也没有太多的共同语言。想平时打打游戏联络一下感情，但是看他很忙的样子，就放弃了。最近才发现，原来小山也看二次元，哈哈哈。反正就这样，和小山半亲近半陌生。和鹏飞一开始也聊的挺多，后面等公司的事情知道的差不多了，也交流的不多了。</p>
<p>而且由于我比较慢热，再加上我进入公司比较晚，没有参加过团建，和大家都不是很熟。就和组内的坐在旁边的外加组内的实习生比较熟。</p>
<p>说一下，我在大搜车实习的感受吧。</p>
<ul>
<li><p>代码层面</p>
<ul>
<li><p>更加理性的对待 callback 和 promise，因为在之前，我是极力反对使用 callback 的，所以当第一眼看到公司的代码的时候，我懵逼了，怎么全是 callback。于是经过和鹏飞的交流以及自己的领悟，终于放下执念。其实 callback+async 和 promise 没啥区别么，哈哈哈。</p>
</li>
<li><p>尝试先写文档，后写代码。我平时兴起的时候，直接就开始撸，从来不打草稿。小项目可以，但是当项目大了之后，就呵呵哒了。</p>
</li>
<li><p>了解了 Node 的 PR 流程。</p>
</li>
<li><p>其他的好像还真的没有了，什么代码规范，git flow，框架的使用等等，我基本都了解。但是又重新复习了并精进了一下。毕竟之前看时候只是看了几眼，大体明白了内容。正好趁着这次实习，运用一下，看看自己理解的哪里有问题。</p>
</li>
</ul>
</li>
<li><p>交际层面</p>
<ul>
<li><p>首先我是一个慢热的，也就是说我不是很擅长去找别人交流，但是别人来找我交流，我是很乐意的。所以说，我当初进入公司之前的幻想，就是大家都在交流着各种新技术，新框架，新事物，当一个人抛出问题的时候，大家会一起去解决研究。结果进来之后，我发现，好像群里半天都不会有任何消息。于是我就努力去带动气氛，有什么好玩的东东都尝试发到群里，结果还是很难带起氛围。不知道是大家太忙了，还是我发的信息太简单。</p>
</li>
<li><p>还记得在学校的时候，社团的技术群，可能一个人发现了新东西，于是群里的大佬一起去尝试，评论，总结。和群里的人撕逼那个语言好，撕逼什么框架好用。我们只追求方便好用，并不怎么在乎稳定性这种东西。哎，这种感觉好难在找回来了。不知道头哥能不能看到我写的，我不知道头哥你想的团队是不是我想的那样，但是感觉大家仅仅为了业务而工作，死气沉沉，不觉得失去了乐趣么？</p>
</li>
<li><p>再讲讲开源的东东，我不知道用我们大学生的思维来思考对不对。至少我会很讨厌所有的公司沉淀出来的产品，比如说阿里的 egg。怎么解释呢？你可以理解假设公司内部的开发版本按照 master 的一条线进行，如果开源了，我就从 master checkout 一个新的分支，然后做一些开源的修改。我为什么不喜欢这种呢？因为这种所有的功能的设计实现就是严重依赖业务的，他只能做到的是在这个业务的情况下尽可能去兼容其他的业务格式而抽离出来的核心。而我真正想要的是什么呢？是社区驱动，一个产品可以由一个公司来开发，但是设计一定还给社区。而且我也不喜欢所谓的二次封装的框架，二次封装的框架我建议内部使用，而不是开源。除非你的二次封装能够提供很多功能。</p>
</li>
</ul>
</li>
<li><p>反正总的来讲，我感觉从知识层面，我获取的很少，没获取到太多新的概念/知识。但是实践层面我获取的还是挺多的。不知道这是不是以后工作的常态。</p>
</li>
</ul>
<h1 id="大学"><a href="#大学" class="headerlink" title="大学"></a>大学</h1><p>这一年其实大学生活没有太多的东西，主要是在实习当中度过的。</p>
<p>正是因为如此，我也越发怀念当初的学习生活。回头看看学弟当中的大佬，不由自主的感叹自己好像虚度了大学生活。</p>
<p>不顾了，下学期就准备毕业设计了，希望自己能珍惜最后的时光吧。</p>
<h1 id="2018-展望"><a href="#2018-展望" class="headerlink" title="2018 展望"></a>2018 展望</h1><p>看过了死月的总结，我发现其实有一点挺好的，一年给自己定一些目标，来年看看目标有没有实现。</p>
<p>那我也来展望一下好了：</p>
<ul>
<li><p>学习</p>
<ul>
<li><p>争取研读 Node 源码，至少要把死月那本书给啃完</p>
</li>
<li><p>争取 Github 每周都有贡献，希望能长久的维护一个项目</p>
</li>
<li><p>争取写一些有意思，有难度的代码，比如说《如何写出一个 Babel》</p>
</li>
<li><p>坚持写文章吧（这个有点难），至少保证每两周一篇高质量的</p>
</li>
<li><p>了解一些其他方面的内容，下一年总结一下了解了啥。</p>
</li>
</ul>
</li>
<li><p>坚持锻炼身体，把体重控制在 65 以下，争取练出胸肌（其实我有，只不过有点萎缩了）腹肌二头肌（当然，这些都练出来之后我就不限制体重了）。</p>
</li>
<li><p>争取学会做几个菜（当然指的是在实习期间了），暂时只考虑用电饭煲来做。</p>
</li>
<li><p>Minecraft 开新坑，等 1.13 发布~如果有小伙伴想入坑的请联系我，最好有正版，因为我是想单人开坑的。</p>
</li>
<li><p>不知道为啥，自从实习之后，感觉有点思春。。。特别想找人聊聊非技术方面的事情。。没妹子陪，我都不想去电影院看电影了。。。所以，不求找女票，感觉自己现在还不是很适合去当男票，其实是找不到合适的，哈哈哈。只求可以找到有空可以出去看个电影，聊个天，而且臭味相投的妹子就好了。不过目测是完不成这个目标了。</p>
</li>
<li><p>既然没有女票，那就多花一些时间在学习上。但是不要死学习，做程序员路上的书呆子。</p>
</li>
<li><p>恶习</p>
<ul>
<li><p>争取改掉拖沓的毛病，有任务赶紧去做，有事情提前安排</p>
</li>
<li><p>争取每天刷牙洗脸（也就是让自己早起，哈哈哈）</p>
</li>
</ul>
</li>
</ul>
<p>先这么多吧，看看 2019 年，我完成了哪些。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/02/16/summary-2018/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/12/30/Reflect-metadata/">
                            Reflect-Metadata 详解
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Sat Dec 30 2017 00:00:00 GMT+0800">
	
		    12月 30, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Frontend/">Frontend</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-text">引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metadata"><span class="toc-text">Metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reflect-Metadata"><span class="toc-text">Reflect Metadata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-%E4%BD%BF%E7%94%A8"><span class="toc-text">安装&#x2F;使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB-%E5%B1%9E%E6%80%A7-%E6%96%B9%E6%B3%95-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">类&#x2F;属性&#x2F;方法 装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%9F%A5%E6%89%BE"><span class="toc-text">原型链查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E9%80%94"><span class="toc-text">用途</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5-Reflect-Metadata"><span class="toc-text">深入 Reflect Metadata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">实现原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#End"><span class="toc-text">End</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E5%A4%96%E8%AF%9D"><span class="toc-text">题外话</span></a></li></ol>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在 ES6 的规范当中，就已经存在 <code>Reflect</code> API 了。简单来说这个 API 的作用就是可以实现对变量操作的函数化，也就是反射。具体的关于这个 API 的内容，可以查看这个<a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/#docs/reflect">教程</a></p>
<p>然而我们在这里讲到的，却是 <code>Reflect</code> 里面还没有的一个规范，那么就是 <code>Reflect Metadata</code>。</p>
<h2 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h2><p>想必对于其他语言的 Coder 来说，比如说 Java 或者 C#，Metadata 是很熟悉的。最简单的莫过于通过反射来获取类属性上面的批注（在 JS 当中，也就是所谓的装饰器）。从而可以更加优雅的对代码进行控制。</p>
<p>而 JS 现在有<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-decorators">装饰器</a>，虽然现在还在 <code>Stage2</code> 阶段。但是 JS 的装饰器更多的是存在于对函数或者属性进行一些操作，比如修改他们的值，代理变量，自动绑定 this 等等功能。</p>
<blockquote>
<p>所以，后文当中我就使用 TypeScript 来进行讲解，因为 TypeScript 已经完整的实现了装饰器。<br>虽然 Babel 也可以，但是需要各种配置，人懒，不想配置那么多。</p>
</blockquote>
<p>但是却无法实现通过反射来获取究竟有哪些装饰器添加到这个类/方法上。</p>
<p>于是 <code>Reflect Metadata</code> 应运而生。</p>
<h2 id="Reflect-Metadata"><a href="#Reflect-Metadata" class="headerlink" title="Reflect Metadata"></a>Reflect Metadata</h2><p>Relfect Metadata，简单来说，你可以通过装饰器来给类添加一些自定义的信息。然后通过反射将这些信息提取出来。当然你也可以通过反射来添加这些信息。<br>就像是下面这个例子所示。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">hello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, A) <span class="comment">// &#x27;A&#x27;</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="keyword">new</span> <span class="title function_">A</span>()) <span class="comment">// &#x27;world&#x27;</span></span><br><span class="line"><span class="comment">// 这里为什么要用 new A()，用 A 不行么？后文会讲到</span></span><br></pre></td></tr></table></figure>
<p>是不是很简单，那么我简单来介绍一下~</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>首先，在这里有四个概念要区分一下：</p>
<ol>
<li><p><code>Metadata Key</code> {Any} 后文简写 <code>k</code>。元数据的 Key，对于一个对象来说，他可以有很多元数据，每一个元数据都对应有一个 Key。一个很简单的例子就是说，你可以在一个对象上面设置一个叫做 <code>&#39;name&#39;</code> 的 Key 用来设置他的名字，用一个 <code>&#39;created time&#39;</code> 的 Key 来表示他创建的时间。这个 Key 可以是任意类型。在后面会讲到内部本质就是一个 <code>Map</code> 对象。</p>
</li>
<li><p><code>Metadata Value</code> {Any} 后文简写 <code>v</code>。元数据的类型，任意类型都行。</p>
</li>
<li><p><code>Target</code> {Object} 后文简写 <code>o</code>。表示要在这个对象上面添加元数据</p>
</li>
<li><p><code>Property</code> {String|Symbol} 后文简写 <code>p</code>。用于设置在那个属性上面添加元数据。大家可能会想，这个是干什么用的，不是可以在对象上面添加元数据了么？其实不仅仅可以在对象上面添加元数据，甚至还可以在对象的属性上面添加元数据。其实大家可以这样理解，当你给一个对象定义元数据的时候，相当于你是默认指定了 <code>undefined</code> 作为 Property。下面有一个例子大家可以看一下。</p>
</li>
</ol>
<p>大家明白了上面的概念之后，我之前给的那个例子就很简单了~不用我多说了。</p>
<h3 id="安装-使用"><a href="#安装-使用" class="headerlink" title="安装/使用"></a>安装/使用</h3><p>下面不如正题，我们怎么开始使用 <code>Reflect Metadata</code> 呢？<br>首先，你需要安装 <code>reflect-metadata</code> polyfill，然后引入之后就可以看到在 <code>Reflect</code> 对象下面有很多关于 Metadata 的函数了。因为这个还没有进入正式的协议，所以需要安装垫片使用。</p>
<blockquote>
<p>啥，Reflect 是啥，一个全局变量而已。</p>
</blockquote>
<p>你不需要担心这个垫片的质量，因为连 Angular 都在使用呢，你怕啥。</p>
<p>之后你就可以安装我上面写的示例，在 TypeScript 当中去跑了。</p>
<h3 id="类-属性-方法-装饰器"><a href="#类-属性-方法-装饰器" class="headerlink" title="类/属性/方法 装饰器"></a>类/属性/方法 装饰器</h3><p>看这个例子。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">hello</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> objs = [A, <span class="keyword">new</span> A, A.<span class="property"><span class="keyword">prototype</span></span>]</span><br><span class="line"><span class="keyword">const</span> res = objs.<span class="title function_">map</span>(<span class="function"><span class="params">obj</span> =&gt;</span> [</span><br><span class="line">  <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, obj),</span><br><span class="line">  <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, obj, <span class="string">&#x27;hello&#x27;</span>),</span><br><span class="line">  <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(<span class="string">&#x27;name&#x27;</span>, obj),</span><br><span class="line">  <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(<span class="string">&#x27;name&#x27;</span>, obj ,<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"><span class="comment">// 大家猜测一下 res 的值会是多少？</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>想好了么？再给你 10 秒钟</p>
</blockquote>
<blockquote>
<p>10<br>9<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1</p>
</blockquote>
<p>res</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [<span class="string">&#x27;A&#x27;</span>, <span class="literal">undefined</span>, <span class="string">&#x27;A&#x27;</span>, <span class="literal">undefined</span>],</span><br><span class="line">  [<span class="literal">undefined</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>],</span><br><span class="line">  [<span class="literal">undefined</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="literal">undefined</span>, <span class="string">&#x27;hello&#x27;</span>],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>那么我来解释一下为什么回是这样的结果。</p>
<p>首先所有的对类的修饰，都是定义在类这个对象上面的，而所有的对类的属性或者方法的修饰，都是定义在类的原型上面的，并且以属性或者方法的 key 作为 property，这也就是为什么 <code>getMetadata</code> 会产生这样的效果了。</p>
<p>那么带 <code>Own</code> 的又是什么情况呢？</p>
<p>这就要从元数据的查找规则开始讲起了</p>
<h3 id="原型链查找"><a href="#原型链查找" class="headerlink" title="原型链查找"></a>原型链查找</h3><p>类似于类的继承，查找元数据的方式也是通过原型链进行的。</p>
<p>就像是上面那个例子，我实例化了一个 <code>new A()</code>，但是我依旧可以找到他原型链上的元数据。</p>
<p>举个例子</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">hello</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> t1 = <span class="keyword">new</span> <span class="title function_">A</span>()</span><br><span class="line"><span class="keyword">const</span> t2 = <span class="keyword">new</span> <span class="title function_">A</span>()</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(<span class="string">&#x27;otherName&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, t2, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, t1, <span class="string">&#x27;hello&#x27;</span>) <span class="comment">// &#x27;hello&#x27;</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, t2, <span class="string">&#x27;hello&#x27;</span>) <span class="comment">// &#x27;hello&#x27;</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;otherName&#x27;</span>, t2, <span class="string">&#x27;hello&#x27;</span>) <span class="comment">// &#x27;world&#x27;</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(<span class="string">&#x27;name&#x27;</span>, t2, <span class="string">&#x27;hello&#x27;</span>) <span class="comment">// undefined</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(<span class="string">&#x27;otherName&#x27;</span>, t2, <span class="string">&#x27;hello&#x27;</span>) <span class="comment">// &#x27;world&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>其实所有的用途都是一个目的，给对象添加额外的信息，但是不影响对象的结构。这一点很重要，当你给对象添加了一个原信息的时候，对象是不会有任何的变化的，不会多 property，也不会有的 property 被修改了。<br>但是可以衍生出很多其他的用途。</p>
<ul>
<li><p>Anuglar 中对特殊字段进行修饰 (Input)，从而提升代码的可读性。</p>
</li>
<li><p>可以让装饰器拥有真正装饰对象而不改变对象的能力。让对象拥有更多语义上的功能。</p>
</li>
</ul>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">Reflect</span> &#123;</span><br><span class="line">  <span class="comment">// 用于装饰器</span></span><br><span class="line">  <span class="title function_">metadata</span>(k, v): <span class="function">(<span class="params">target, property?</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 在对象上面定义元数据</span></span><br><span class="line">  <span class="title function_">defineMetadata</span>(k, v, o, p?): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 是否存在元数据</span></span><br><span class="line">  <span class="title function_">hasMetadata</span>(k, o, p?): <span class="built_in">boolean</span></span><br><span class="line">  <span class="title function_">hasOwnMetadata</span>(k, o, p?): <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// 获取元数据</span></span><br><span class="line">  <span class="title function_">getMetadata</span>(k, o, p?): <span class="built_in">any</span></span><br><span class="line">  <span class="title function_">getOwnMetadata</span>(k, o, p?): <span class="built_in">any</span></span><br><span class="line">  <span class="comment">// 获取所有元数据的 Key</span></span><br><span class="line">  <span class="title function_">getMetadataKeys</span>(o, p?): <span class="built_in">any</span>[]</span><br><span class="line">  <span class="title function_">getOwnMetadataKeys</span>(o, p?): <span class="built_in">any</span>[]</span><br><span class="line">  <span class="comment">// 删除元数据</span></span><br><span class="line">  <span class="title function_">deleteMetadata</span>(k, o, p?): <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>大家可能注意到，针对某些操作，会有 <code>Own</code> 的函数。这是因为有的操作是可以通过原型链进行操作的。这个后文讲解。</p>
</blockquote>
<h2 id="深入-Reflect-Metadata"><a href="#深入-Reflect-Metadata" class="headerlink" title="深入 Reflect Metadata"></a>深入 Reflect Metadata</h2><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>如果你去翻看官网的文档，他会和你说，所有的元数据都是存在于对象下面的 <code>[[Metadata]]</code> 属性下面。一开始我也是这样认为的，新建一个 <code>Symbol(&#39;Metadata&#39;)</code>，然后将元数据放到这个 Symbol 对应的 Property 当中。直到我看了源码才发现并不是这样。请看例子</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getOwnPropertySymbols</span>(A) <span class="comment">// []</span></span><br></pre></td></tr></table></figure>
<p>哈哈，并没有所谓的 Symbol，那么这些元数据都存在在哪里呢？</p>
<p>其实是内部的一个 WeakMap 中。他正是利用了 WeakMap 不增加引用计数的特点，将对象作为 Key，元数据集合作为 Value，存到 WeakMap 中去。</p>
<p>如果你认真探寻的话，你会发现其内部的数据结构其实是这样的</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">WeakMap</span>&lt;<span class="built_in">any</span>, <span class="title class_">Map</span>&lt;<span class="built_in">any</span>, <span class="title class_">Map</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>是不是超级绕，但是我们从调用的角度来思考，这就一点都不绕了。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weakMap.<span class="title function_">get</span>(o).<span class="title function_">get</span>(p).<span class="title function_">get</span>(k)</span><br></pre></td></tr></table></figure>
<p>先根据对象获取，然后在根据属性，最后根据元数据的 Key 获取最终要的数据。</p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>因为 Reflect Metadata 实在是比较简单，这里就不多讲解了。更多内容请查看 <a target="_blank" rel="noopener" href="https://rbuckton.github.io/reflect-metadata">Spec</a></p>
<h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>其实看了源码之后还是挺惊讶的，按照一般的套路，很多 polyfill 会让你提供一些前置的 polyfill 之后，当前的 polyfill 才能使用。但是 <code>reflect-metadata</code> 竟然内部自己实现了很多的 polyfill 和算法。比如 Map, Set, WeakMap, UUID。最惊讶的莫过于 WeakMap 了。不是很仔细的阅读了一下，好像还是会增加引用计数。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/12/30/Reflect-metadata/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/09/09/boostnote-is-an-open-source-note-taking-app-designed-for-programmers/">
                            Boostnote 一个专门为程序员设计的笔记应用
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Sat Sep 09 2017 22:40:27 GMT+0800">
	
		    9月 09, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Software/">Software</a>


    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    
<blockquote>
<p>Boostnote 是一款通过 Electron 构建的桌面笔记应用。它支持离线存储，无需注册、Markdown 编辑、像 Github Gist 的代码片段的管理等等内容。全球 198 个国家和地区的程序员们在使用这款应用。</p>
</blockquote>
<p><a href="https://boostnote.io/" target="_blank" rel="noopener">Boostnote</a> 就如同器名字一般，最主要的一个用途便是 Markdown 笔记编辑器。你所有的 Markdown 笔记拥有自动保存的功能，并且支持多种展示格式。拥有半实时的预览，所以你可以及时的检查最后的格式是否是和你所输入的一致。</p>
<p>Latex 公式编辑器也内置在 Boostnote 当中，你可以很轻松的插入各种公式在你的笔记中。</p>
<p>不管是笔记还是代码片段都可以通过标签的方式进行管理。</p>
<p>对于代码片段来说，他支持高达 100 多种语言的高亮，其中包括 JavaScript, Python, HTML 和 CSS。当然你也可以在一份代码片段当中存储多段代码，比如说你可以同时存储 HTML，CSS，JS 代码在一份当中。而且不管你是用什么样子的缩进（tab/空格）或者缩进的程度（2个字符，4个字符，8个字符）都可以在文档中进行配置。</p>
<p>最后，将笔记导出成普通文本（.txt） 或者 Markdown(.md) 也是支持的功能。</p>
<h2 id="外观（UI）"><a href="#外观（UI）" class="headerlink" title="外观（UI）"></a>外观（UI）</h2><p>丰富的快捷键可以让你让更快的浏览、搜索笔记，以及更快的执行一些重要操作。</p>
<p>对于 Boostnote 的外观来说，你有很多种不同的主题可以选择。当然，编辑器的高亮也是有很多种可以选择的，你可以根据你自己的喜好自由搭配。你可以在 <code>Preferences</code> &gt; <code>UI</code> &gt; <code>Theme</code> 查看支持的主题。</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>Boostnote 目前是开源的，你可以通过<a href="https://boostnote.io/#download" target="_blank" rel="noopener">官网</a>下载。不过要注意的是，存储使用的是亚马逊的 s3，所以你需要能够翻墙，否则无法下载。</p>
<p>它目前是支持全平台（Windows, MacOS, Linux，IOS，Android）</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/09/09/boostnote-is-an-open-source-note-taking-app-designed-for-programmers/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        <li class="pagination-prev">
            
                <a class="btn btn--default btn--small" href="/%20">
            
                <i class="fa fa-angle-left text-base icon-mr"></i>
                    <span>上一页</span>
            </a>
        </li>
        
        
        <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/page/3/">
                    <span>下一页</span>
                <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
        </li>
        
        <li class="pagination-number">第 2 页 共 4 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 XGHeaven. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/f34474afe04544ffbe944a804f0ae762?s=110"/>
        
            <h4 id="about-card-name">XGHeaven</h4>
        
            <h5 id="about-card-bio"><p>一个弱弱的码农</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>杭州电子科技大学学生一枚</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Weifang Shandong, China
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/static/images/20170217-TombRaider.jpg');"></div>
    </body>
    <!--SCRIPTS-->

<script src="/assets/js/scrip-z6xcdnzggiy56kzp83ux5nnbwra1acrauxruz3kdi3u5xladb6jh4n3ylebm.min.js"></script>

<!--SCRIPTS END-->



</html>
